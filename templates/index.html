<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easemylease</title>
    <!-- PDF.js library for rendering PDFs in modal -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* Base styles */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(180deg, #f8f9fb 0%, #eef1f5 50%, #e4e9f0 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 40px 20px 60px;
            line-height: 1.6;
            color: #333;
            min-height: 100vh;
        }

        /* Container */
        .container {
            max-width: 860px;
            margin: 0 auto;
        }

        /* Page header */
        .page-header {
            margin-bottom: 32px;
            position: relative;
        }
        .page-header::before {
            content: '';
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 200px;
            background: radial-gradient(ellipse at center, rgba(99, 132, 227, 0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }
        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 8px 0;
        }
        .page-header p {
            color: #6b7280;
            margin: 0;
            font-size: 16px;
        }

        /* Card component */
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 6px 16px rgba(0, 0, 0, 0.06);
            padding: 28px 32px;
            margin-bottom: 24px;
        }
        .card-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .card-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 4px 0;
        }
        .card-header p {
            color: #6b7280;
            margin: 0;
            font-size: 14px;
        }

        /* Upload form card */
        .upload-form {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 28px 32px;
            margin-bottom: 24px;
        }
        .upload-form h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 4px 0;
        }
        .upload-form > p {
            color: #6b7280;
            margin: 0 0 20px 0;
            font-size: 14px;
        }
        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            background: #fafafa;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-zone:hover {
            border-color: #007bff;
            background: #f8faff;
        }
        .upload-form input[type="file"] {
            margin: 12px 0 16px 0;
            font-size: 14px;
        }
        .upload-form button {
            background: #007bff;
            color: white;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .upload-form button:hover {
            background: #0056b3;
        }

        /* Flash messages */
        .flash-messages {
            margin-bottom: 24px;
        }
        .flash-message {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
        }
        .flash-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Uploads section */
        .uploads-section {
            margin-bottom: 24px;
        }
        .uploads-section > h3 {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 16px 0;
        }

        /* Upload item (extracted text card) */
        .upload-item {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px 28px;
        }
        .upload-item h4 {
            margin: 0 0 6px 0;
            color: #1a1a2e;
            font-size: 16px;
            font-weight: 600;
            word-break: break-all;
        }
        .preview-box {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            color: #555;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 150px;
            overflow-y: auto;
        }
        .no-text {
            color: #9ca3af;
            font-style: italic;
        }
        .file-type {
            font-size: 13px;
            color: #9ca3af;
            margin-bottom: 16px;
        }

        /* Confirm form card */
        .confirm-form {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 28px 32px;
            margin-bottom: 24px;
        }
        .confirm-form h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 4px 0;
        }
        .confirm-form > p {
            color: #6b7280;
            margin: 0 0 24px 0;
            font-size: 14px;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: #4b5563;
        }
        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fff;
        }
        .form-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }
        .form-group input::placeholder {
            color: #9ca3af;
        }
        /* AI suggestion hint - subtle helper text */
        .ai-hint {
            display: none;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
            font-style: italic;
        }
        .ai-hint.visible {
            display: block;
        }
        /* AI-filled field indicator - subtle blue tint */
        .ai-filled {
            background-color: #f0f9ff !important;
            border-color: #bae6fd !important;
        }
        .ai-filled:focus {
            background-color: #fff !important;
        }
        /* User-edited field indicator - subtle green tint (locked from AI) */
        .user-edited {
            background-color: #f0fdf4 !important;
            border-color: #bbf7d0 !important;
        }
        .user-edited:focus {
            background-color: #fff !important;
        }
        .field-explanation {
            font-size: 12px;
            color: #6b7280;
            margin-top: 3px;
            font-style: italic;
        }
        /* AI Assistance summary card */
        .ai-summary {
            display: none;
            margin-top: 20px;
            padding: 14px 18px;
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-left: 3px solid #60a5fa;
            border-radius: 6px;
            font-size: 13px;
            color: #4b5563;
        }
        .ai-summary.visible {
            display: block;
        }
        .ai-summary-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .ai-summary ul {
            margin: 0;
            padding-left: 18px;
        }
        .ai-summary li {
            margin-bottom: 4px;
        }
        .ai-summary li:last-child {
            margin-bottom: 0;
        }
        .form-row {
            display: flex;
            gap: 20px;
        }
        .form-row .form-group {
            flex: 1;
        }

        /* Primary button (Save) */
        .confirm-form button[type="submit"] {
            background: #28a745;
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .confirm-form button[type="submit"]:hover {
            background: #218838;
        }

        /* Text reference box */
        .full-text-box {
            width: 100%;
            height: 180px;
            padding: 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 13px;
            background: #f9fafb;
            resize: vertical;
            box-sizing: border-box;
            color: #4b5563;
        }
        .text-reference {
            margin-top: 20px;
        }
        .text-reference label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: #4b5563;
        }

        /* View section card */
        .view-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 28px 32px;
            margin-bottom: 24px;
        }
        .view-section h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 20px 0;
        }
        .field-row {
            display: flex;
            padding: 14px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .field-row:last-of-type {
            border-bottom: none;
        }
        .field-label {
            font-weight: 500;
            color: #6b7280;
            width: 180px;
            flex-shrink: 0;
            font-size: 14px;
        }
        .field-value {
            color: #1a1a2e;
            font-size: 15px;
        }

        /* Button: Edit - Pastel Blue */
        .btn-edit {
            display: inline-block;
            background: #e0f2fe;
            color: #0369a1;
            padding: 12px 24px;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s, border-color 0.2s;
        }
        .btn-edit:hover {
            background: #bae6fd;
            border-color: #7dd3fc;
        }

        /* Button: Cancel */
        .btn-cancel {
            display: inline-block;
            margin-left: 12px;
            background: #6b7280;
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-cancel:hover {
            background: #4b5563;
        }

        /* Button: Reset / Destructive - Pastel Red */
        .btn-reset {
            display: inline-block;
            background: #fee2e2;
            color: #b91c1c;
            padding: 12px 24px;
            border: 1px solid #fecaca;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s, border-color 0.2s;
        }
        .btn-reset:hover {
            background: #fecaca;
            border-color: #fca5a5;
        }

        /* Form buttons container */
        .form-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 28px;
            padding-top: 24px;
            border-top: 1px solid #e5e7eb;
        }

        /* Button: AI */
        .btn-ai {
            background: #6f42c1;
            color: white;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-ai:hover {
            background: #5a32a3;
        }
        .btn-ai:disabled {
            background: #a88cd4;
            cursor: not-allowed;
        }

        /* AI message */
        .ai-message {
            margin-top: 20px;
            padding: 14px 18px;
            border-radius: 8px;
            display: none;
            font-size: 14px;
        }
        .ai-message.visible {
            display: block;
        }
        .ai-message.error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        .ai-message.success {
            background: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .ai-message.loading {
            background: #f5f3ff;
            color: #5b21b6;
            border: 1px solid #ddd6fe;
        }

        /* AI Update Summary */
        .ai-update-summary {
            margin-bottom: 12px;
        }
        .ai-update-summary strong {
            display: block;
            margin-bottom: 6px;
        }
        .ai-update-list {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            color: #166534;
        }
        .ai-update-list li {
            margin-bottom: 2px;
        }

        /* AI Not-Filled Summary */
        .ai-notfilled-summary {
            margin-top: 14px;
            padding: 10px 14px;
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 6px;
        }
        .ai-notfilled-summary strong {
            display: block;
            margin-bottom: 6px;
            color: #92400e;
            font-size: 13px;
        }
        .ai-notfilled-list {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            color: #92400e;
        }
        .ai-notfilled-list li {
            margin-bottom: 8px;
        }
        .ai-notfilled-reason {
            display: block;
            font-size: 12px;
            color: #b45309;
            margin-top: 2px;
            padding-left: 4px;
        }
        .ai-ocr-note {
            margin-top: 10px;
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }

        /* AI Overwrite Warning */
        .ai-overwrite-warning {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 6px;
            padding: 12px 14px;
            margin-top: 12px;
        }
        .ai-overwrite-warning strong {
            display: block;
            margin-bottom: 8px;
            color: #92400e;
            font-size: 13px;
        }
        .ai-overwrite-list {
            margin: 0;
            padding-left: 0;
            list-style: none;
            font-size: 13px;
        }
        .ai-overwrite-list li {
            margin-bottom: 6px;
            padding: 6px 10px;
            background: #fef3c7;
            border-radius: 4px;
        }
        .ai-overwrite-list li:last-child {
            margin-bottom: 0;
        }
        .ai-overwrite-list .field-name {
            font-weight: 600;
            color: #78350f;
        }
        .ai-overwrite-list .old-value {
            color: #b91c1c;
            text-decoration: line-through;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }
        .ai-overwrite-list .arrow {
            color: #9ca3af;
            margin: 0 4px;
        }
        .ai-overwrite-list .new-value {
            color: #166534;
            font-weight: 500;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }

        /* Unified changes section (Previous values replaced) */
        .unified-changes-container {
            margin-top: 16px;
        }
        .unified-changes {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 18px;
        }
        .unified-changes h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .changes-list {
            margin: 0;
            padding-left: 0;
            list-style: none;
            font-size: 13px;
        }
        .changes-list li {
            margin-bottom: 6px;
            padding: 8px 12px;
            background: #fff;
            border: 1px solid #f0f0f0;
            border-radius: 6px;
            line-height: 1.7;
        }
        .changes-list li:last-child {
            margin-bottom: 0;
        }
        .changes-list .field-name {
            font-weight: 600;
            color: #1f2937;
        }
        .changes-list .old-value {
            color: #b91c1c;
            text-decoration: line-through;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }
        .changes-list .arrow {
            color: #9ca3af;
            margin: 0 4px;
        }
        .changes-list .new-value {
            color: #166534;
            font-weight: 500;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
        }
        .source-tag {
            display: inline-block;
            font-size: 11px;
            padding: 1px 8px;
            border-radius: 10px;
            margin-left: 6px;
            font-weight: 500;
            vertical-align: middle;
        }
        .source-ai {
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        .source-version {
            background: #f3f4f6;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        /* Version changes in View Mode */
        .btn-toggle-changes {
            display: inline-block;
            background: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 8px;
        }
        .btn-toggle-changes:hover {
            background: #dbeafe;
        }
        .change-old,
        .change-removed {
            color: #b91c1c;
            text-decoration: line-through;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }
        .change-arrow {
            color: #9ca3af;
            margin: 0 6px;
        }
        .change-new,
        .change-added {
            color: #1e40af;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }
        .change-note {
            color: #6b7280;
            font-style: italic;
            font-size: 12px;
            margin-left: 4px;
        }

        /* Reminder urgency styles */
        .reminder-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px 28px;
            margin-bottom: 24px;
        }
        .reminder-card h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 20px 0;
        }
        .reminder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }
        .reminder-item {
            padding: 16px 20px;
            border-radius: 10px;
            border-left: 4px solid;
        }
        .reminder-item .reminder-label {
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 6px;
        }
        .reminder-item .reminder-days {
            font-size: 32px;
            font-weight: 700;
            line-height: 1.1;
        }
        .reminder-item .reminder-days span {
            font-size: 14px;
            font-weight: 500;
        }
        .reminder-item .reminder-message {
            font-size: 14px;
            margin-top: 6px;
        }
        .urgency-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* Urgency: None */
        .reminder-item.urgency-none {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .reminder-item.urgency-none .reminder-label { color: #6b7280; }
        .reminder-item.urgency-none .reminder-days { color: #374151; }
        .reminder-item.urgency-none .reminder-message { color: #6b7280; }
        .urgency-badge.urgency-none {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* Urgency: Info - VIBRANT BLUE */
        .reminder-item.urgency-info {
            background: #eff6ff;
            border-color: #2563eb;
        }
        .reminder-item.urgency-info .reminder-label { color: #2563eb; }
        .reminder-item.urgency-info .reminder-days { color: #1d4ed8; }
        .reminder-item.urgency-info .reminder-message { color: #2563eb; }
        .urgency-badge.urgency-info {
            background: #60a5fa;
            color: #1e3a8a;
        }

        /* Urgency: Warning - VIBRANT AMBER */
        .reminder-item.urgency-warning {
            background: #fef6e0;
            border-color: #f59e0b;
        }
        .reminder-item.urgency-warning .reminder-label { color: #d97706; }
        .reminder-item.urgency-warning .reminder-days { color: #b45309; }
        .reminder-item.urgency-warning .reminder-message { color: #d97706; }
        .urgency-badge.urgency-warning {
            background: #fbbf24;
            color: #78350f;
        }

        /* Urgency: Urgent - VIBRANT ORANGE */
        .reminder-item.urgency-urgent {
            background: #fff1e6;
            border-color: #ea580c;
        }
        .reminder-item.urgency-urgent .reminder-label { color: #ea580c; }
        .reminder-item.urgency-urgent .reminder-days { color: #c2410c; }
        .reminder-item.urgency-urgent .reminder-message { color: #ea580c; }
        .urgency-badge.urgency-urgent {
            background: #fb923c;
            color: #7c2d12;
        }

        /* Urgency: Critical - VIBRANT RED */
        .reminder-item.urgency-critical {
            background: #fee8e8;
            border-color: #dc2626;
        }
        .reminder-item.urgency-critical .reminder-label { color: #dc2626; }
        .reminder-item.urgency-critical .reminder-days { color: #b91c1c; }
        .reminder-item.urgency-critical .reminder-message { color: #dc2626; }
        .urgency-badge.urgency-critical {
            background: #f87171;
            color: #fff;
        }

        /* ========================================
           URGENCY ESCALATION - Visual Enhancements
           ======================================== */

        /* Keyframes: Slow pulse for urgent level - VIBRANT */
        @keyframes pulse-urgent {
            0%, 100% {
                box-shadow: 0 2px 4px rgba(234, 88, 12, 0.2), 0 4px 12px rgba(234, 88, 12, 0.1);
            }
            50% {
                box-shadow: 0 2px 8px rgba(234, 88, 12, 0.4), 0 6px 20px rgba(234, 88, 12, 0.25);
            }
        }

        /* Keyframes: Subtle horizontal shake for critical level (max 2px) */
        @keyframes shake-critical {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-1px); }
            40% { transform: translateX(2px); }
            60% { transform: translateX(-2px); }
            80% { transform: translateX(1px); }
        }

        /* Enhanced Warning: stronger border + vibrant warning shadow */
        .reminder-item.urgency-warning {
            border-left-width: 5px;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.25), 0 4px 12px rgba(245, 158, 11, 0.15);
        }

        /* Enhanced Urgent: vibrant orange + slow pulse animation */
        .reminder-item.urgency-urgent {
            border-left-width: 5px;
            background: #fff1e6;
            box-shadow: 0 2px 4px rgba(234, 88, 12, 0.25), 0 4px 12px rgba(234, 88, 12, 0.15);
            animation: pulse-urgent 2.5s ease-in-out infinite;
        }

        /* Enhanced Critical: vibrant red + subtle shake animation */
        .reminder-item.urgency-critical {
            border-left-width: 6px;
            background: #fee8e8;
            border-color: #dc2626;
            box-shadow: 0 2px 6px rgba(220, 38, 38, 0.3), 0 4px 14px rgba(220, 38, 38, 0.2);
            animation: shake-critical 0.6s ease-in-out infinite;
            animation-delay: 3s;
        }

        /* Urgency icon styling */
        .urgency-icon {
            margin-right: 3px;
            font-style: normal;
        }

        /* ======================================== */

        /* View section button group */
        .view-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #f3f4f6;
        }
        .view-actions .btn-edit,
        .view-actions .btn-reset,
        .view-actions .btn-renew,
        .view-actions form {
            margin: 0;
        }

        /* Button: Renew - Pastel Green */
        .btn-renew {
            display: inline-block;
            background: #d1fae5;
            color: #065f46;
            padding: 12px 24px;
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            text-decoration: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s, border-color 0.2s;
        }
        .btn-renew:hover {
            background: #a7f3d0;
            border-color: #6ee7b7;
        }

        /* Button: Delete Lease (dashboard cards) */
        .btn-delete-lease {
            display: block;
            width: 100%;
            padding: 10px 16px;
            margin-top: 8px;
            background: #fff;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }
        .btn-delete-lease:hover {
            background: #fef2f2;
            border-color: #f87171;
        }

        /* Renewal context message */
        .renewal-context {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-left: 3px solid #22c55e;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #166534;
        }
        .renewal-context strong {
            color: #15803d;
        }

        /* ========================================
           LEASE VERSION HISTORY
           ======================================== */
        .version-history {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 24px 28px;
            margin-bottom: 24px;
        }
        .version-history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .version-history-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0;
        }
        .version-count {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 10px;
            border-radius: 12px;
        }
        .version-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .version-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            color: inherit;
            transition: background 0.15s, border-color 0.15s;
        }
        .version-item.current {
            background: #eff6ff;
            border-color: #bfdbfe;
        }
        .version-item.previous {
            opacity: 0.85;
        }
        .version-badge {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            background: #f3f4f6;
            padding: 6px 12px;
            border-radius: 6px;
            min-width: 32px;
            text-align: center;
        }
        .version-item.current .version-badge {
            background: #3b82f6;
            color: #fff;
        }
        .version-details {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 8px 24px;
            font-size: 13px;
        }
        .version-detail {
            display: flex;
            gap: 6px;
        }
        .version-detail-label {
            color: #9ca3af;
        }
        .version-detail-value {
            color: #374151;
            font-weight: 500;
        }
        .version-item.previous .version-detail-value {
            color: #6b7280;
        }
        .version-status {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 10px;
            border-radius: 4px;
        }
        .version-status.current {
            background: #dcfce7;
            color: #166534;
        }
        .version-status.previous {
            background: #f3f4f6;
            color: #6b7280;
        }
        .version-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .btn-view-version {
            padding: 6px 12px;
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }
        .btn-view-version:hover {
            background: #dbeafe;
            border-color: #93c5fd;
        }
        .btn-view-version.viewing {
            background: #e0e7ff;
            color: #4338ca;
            border-color: #c7d2fe;
            cursor: default;
        }
        .btn-delete-version {
            padding: 6px 12px;
            background: #fff;
            color: #dc2626;
            border: 1px solid #fecaca;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }
        .btn-delete-version:hover {
            background: #fef2f2;
            border-color: #f87171;
        }

        /* ========================================
           DELETE CONFIRMATION MODAL
           ======================================== */
        .delete-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .delete-modal-overlay.visible {
            display: flex;
        }
        .delete-modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            max-width: 480px;
            width: 90%;
            overflow: hidden;
        }
        .delete-modal-header {
            background: #fef2f2;
            border-bottom: 1px solid #fecaca;
            padding: 20px 24px;
        }
        .delete-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #991b1b;
        }
        .delete-modal-body {
            padding: 24px;
        }
        .delete-modal-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .delete-modal-warning p {
            margin: 0;
            font-size: 14px;
            color: #991b1b;
            line-height: 1.5;
        }
        .delete-modal-warning strong {
            display: block;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .delete-modal-info {
            margin-bottom: 20px;
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }
        .delete-modal-info .lease-name {
            font-weight: 600;
            color: #1a1a2e;
        }
        .delete-modal-confirm {
            margin-bottom: 20px;
        }
        .delete-modal-confirm label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        .delete-modal-confirm code {
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
        }
        .delete-modal-confirm input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 15px;
            box-sizing: border-box;
        }
        .delete-modal-confirm input:focus {
            outline: none;
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
        }
        .delete-modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 24px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        .delete-modal-cancel {
            padding: 12px 24px;
            background: #fff;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s;
        }
        .delete-modal-cancel:hover {
            background: #f3f4f6;
        }
        .delete-modal-submit {
            padding: 12px 24px;
            background: #dc2626;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, opacity 0.15s;
        }
        .delete-modal-submit:hover:not(:disabled) {
            background: #b91c1c;
        }
        .delete-modal-submit:disabled {
            background: #fca5a5;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .delete-trigger {
            cursor: pointer;
        }

        /* ========================================
           MISSING DOCUMENT MODAL (legacy lease)
           ======================================== */
        .missing-doc-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .missing-doc-overlay.visible {
            display: flex;
        }
        .missing-doc-modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            max-width: 480px;
            width: 90%;
            overflow: hidden;
        }
        .missing-doc-header {
            background: #eff6ff;
            border-bottom: 1px solid #bfdbfe;
            padding: 20px 24px;
        }
        .missing-doc-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #1e40af;
        }
        .missing-doc-body {
            padding: 24px;
        }
        .missing-doc-body p {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: #374151;
            line-height: 1.6;
        }
        .missing-doc-body p:last-child {
            margin-bottom: 0;
        }
        .missing-doc-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 24px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        .missing-doc-close {
            padding: 12px 24px;
            background: #fff;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .missing-doc-close:hover {
            background: #f3f4f6;
        }
        .missing-doc-action {
            display: inline-block;
            padding: 12px 24px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        .missing-doc-action:hover {
            background: #1d4ed8;
        }

        /* ========================================
           AI SUGGESTIONS PREVIEW MODAL
           ======================================== */
        .ai-preview-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .ai-preview-overlay.visible {
            display: flex;
        }
        .ai-preview-modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            max-width: 640px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .ai-preview-header {
            background: #f5f3ff;
            border-bottom: 1px solid #ddd6fe;
            padding: 20px 24px;
        }
        .ai-preview-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #5b21b6;
        }
        .ai-preview-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        .ai-preview-note {
            font-size: 13px;
            color: #6b7280;
            margin: 0 0 16px 0;
            font-style: italic;
        }
        .ai-preview-field {
            margin-bottom: 16px;
        }
        .ai-preview-field:last-child {
            margin-bottom: 0;
        }
        .ai-preview-label {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        .ai-preview-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            font-size: 14px;
            color: #374151;
            background-color: #eff6ff;
            box-sizing: border-box;
        }
        .ai-preview-input:focus {
            outline: none;
            border-color: #93c5fd;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .ai-preview-input.preview-edited {
            background-color: #fefce8;
            border-color: #fde68a;
        }
        .ai-preview-input.preview-edited:focus {
            border-color: #fbbf24;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
        }
        .ai-preview-hint {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 3px;
        }
        .ai-preview-notfound-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        .ai-preview-notfound-heading {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin: 0 0 4px 0;
        }
        .ai-preview-notfound-reason {
            font-size: 12px;
            color: #9ca3af;
            margin: 0 0 16px 0;
            font-style: italic;
        }
        .ai-preview-input.preview-notfound {
            background-color: #fff;
            border-color: #d1d5db;
        }
        .ai-preview-input.preview-notfound:focus {
            border-color: #93c5fd;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .ai-preview-input.preview-notfound.preview-edited {
            background-color: #fefce8;
            border-color: #fde68a;
        }
        .ai-preview-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 16px 24px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }
        .ai-preview-cancel {
            padding: 12px 24px;
            background: #fff;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .ai-preview-cancel:hover {
            background: #f3f4f6;
        }
        .ai-preview-apply {
            padding: 12px 24px;
            background: #6f42c1;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .ai-preview-apply:hover {
            background: #5a32a3;
        }
        .ai-preview-pdf {
            display: inline-block;
            padding: 12px 24px;
            background: #2563eb;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }
        .ai-preview-pdf:hover {
            background: #1d4ed8;
        }

        /* ========================================
           GLOBAL LOADING OVERLAY
           ======================================== */
        .global-loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            z-index: 900;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
        }
        .global-loading-overlay.visible {
            display: flex;
        }
        .global-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #6f42c1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .global-loading-message {
            font-size: 15px;
            color: #374151;
            font-weight: 500;
        }
        .loading-card {
            background: white;
            padding: 32px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
            text-align: center;
            max-width: 360px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        /* ========================================
           EXTRACTED TEXT MODAL
           ======================================== */
        .text-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .text-modal-overlay.visible {
            display: flex;
        }
        .text-modal {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .text-modal-header {
            background: #f0f9ff;
            border-bottom: 1px solid #bae6fd;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .text-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #0369a1;
        }
        .text-modal-close {
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: #0369a1;
            cursor: pointer;
        }
        .text-modal-close:hover {
            background: #bae6fd;
        }
        @media print {
            body * { visibility: hidden; }
            #changesModal, #changesModal * { visibility: visible; }
            #changesModal { position: absolute; left: 0; top: 0; background: none; }
            #changesModal .text-modal { box-shadow: none; max-height: none; width: 100%; }
            #changesModal .text-modal-header div { display: none; }
            #submissionsModal, #submissionsModal * { visibility: visible; }
            #submissionsModal { position: absolute; left: 0; top: 0; background: none; }
            #submissionsModal .text-modal { box-shadow: none; max-height: none; width: 100%; }
            #submissionsModal .text-modal-header div { display: none; }
        }
        .text-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        .text-modal-body textarea {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.6;
            background: #f9fafb;
            color: #374151;
            resize: vertical;
            box-sizing: border-box;
        }
        /* PDF Modal Specific Styles */
        .pdf-modal {
            max-width: 1200px;
            width: 95%;
        }
        .pdf-modal-body {
            padding: 0;
            height: 80vh;
            overflow-y: auto;
        }
        #pdfViewer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 10px;
        }
        #pdfViewer canvas {
            max-width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .btn-view-text {
            background: #e0f2fe;
            border: 1px solid #7dd3fc;
            color: #0369a1;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn-view-text:hover {
            background: #bae6fd;
        }

        /* ========================================
           LEASE DETAILS - Grouping & Hierarchy
           ======================================== */

        /* Lease nickname as title */
        .lease-title {
            font-size: 22px;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 20px 0;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }
        .lease-title-label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .lease-added-date {
            font-size: 13px;
            color: #9ca3af;
            margin-top: -12px;
            margin-bottom: 20px;
        }

        /* Section group container */
        .details-group {
            margin-bottom: 24px;
        }
        .details-group:last-of-type {
            margin-bottom: 0;
        }

        /* Section header */
        .details-group-header {
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin: 0 0 12px 0;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }
        .details-group:first-of-type .details-group-header {
            padding-top: 0;
            border-top: none;
        }

        /* Remove bottom border from last field-row in group */
        .details-group .field-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        /* Date values - bolder emphasis */
        .field-value.value-date {
            font-weight: 600;
            color: #111827;
        }

        /* Money values - monospace + green tint */
        .field-value.value-money {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-weight: 600;
            color: #059669;
            letter-spacing: -0.3px;
        }

        /* Metadata section - muted styling */
        .details-meta {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px dashed #d1d5db;
        }
        .details-meta .field-row {
            padding: 8px 0;
            border-bottom: none;
        }
        .details-meta .field-label {
            color: #9ca3af;
            font-size: 13px;
        }
        .details-meta .field-value {
            color: #6b7280;
            font-size: 13px;
        }

        /* ======================================== */

        /* ========================================
           LEASES DASHBOARD - Grid View
           ======================================== */

        .leases-dashboard {
            margin-bottom: 32px;
        }
        .leases-dashboard-header {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 24px;
        }
        .leases-dashboard h3 {
            font-size: 22px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0;
        }
        .leases-dashboard-count {
            font-size: 13px;
            color: #6b7280;
            font-weight: 400;
        }
        .leases-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        @media (max-width: 640px) {
            .leases-grid {
                grid-template-columns: 1fr;
            }
        }
        .lease-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.04);
            padding: 20px;
            text-decoration: none;
            color: inherit;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.15s, border-color 0.15s;
            border: 1px solid #e5e7eb;
            cursor: default;
        }
        .lease-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 8px 24px rgba(0, 0, 0, 0.06);
            border-color: #d1d5db;
        }
        .lease-card.active {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #fff 100%);
        }
        .lease-card.active:hover {
            transform: none;
        }
        .lease-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .lease-card-name {
            font-weight: 600;
            font-size: 16px;
            color: #1a1a2e;
            line-height: 1.3;
        }
        .lease-card-badge {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px;
            border-radius: 6px;
            background: #3b82f6;
            color: #fff;
            flex-shrink: 0;
            margin-left: 12px;
        }
        .lease-card-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: auto;
        }
        .lease-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .lease-card-label {
            color: #6b7280;
        }
        .lease-card-value {
            color: #374151;
            font-weight: 500;
        }
        .lease-card-value.rent {
            color: #059669;
            font-family: 'SF Mono', Monaco, monospace;
        }
        .lease-card-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f3f4f6;
            font-size: 11px;
            color: #9ca3af;
        }

        /* Lease Card Urgency Levels - Subtle Visual Cues */
        .lease-card.urgency-none {
            /* Default - no changes */
        }
        .lease-card.urgency-info {
            border-left: 3px solid #93c5fd;
            background: linear-gradient(135deg, #f8fafc 0%, #fff 100%);
        }
        .lease-card.urgency-warning {
            border-left: 3px solid #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);
        }
        .lease-card.urgency-urgent {
            border-left: 3px solid #f87171;
            background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
        }
        .lease-card.urgency-critical {
            border-left: 4px solid #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.1), 0 6px 16px rgba(0, 0, 0, 0.08);
        }
        /* Override active card styling when urgency present */
        .lease-card.active.urgency-info {
            border-color: #3b82f6;
            border-left: 3px solid #93c5fd;
        }
        .lease-card.active.urgency-warning {
            border-color: #f59e0b;
            border-left: 3px solid #fbbf24;
        }
        .lease-card.active.urgency-urgent {
            border-color: #ef4444;
            border-left: 3px solid #f87171;
        }
        .lease-card.active.urgency-critical {
            border-color: #dc2626;
            border-left: 4px solid #dc2626;
        }

        /* Dashboard-First View */
        .dashboard-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 28px;
        }

        /* Global Alerts Ticker */
        .global-alerts {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            overflow: hidden;
        }
        .global-alerts-header {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            padding: 12px 16px 8px;
            border-bottom: 1px solid #f3f4f6;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .alert-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            text-decoration: none;
            color: inherit;
            border-bottom: 1px solid #f9fafb;
            transition: background 0.1s;
        }
        .alert-row:last-child {
            border-bottom: none;
        }
        .alert-row:hover {
            background: #f9fafb;
        }
        .alert-urgency {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            padding: 3px 8px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .alert-urgency.critical {
            background: #fef2f2;
            color: #dc2626;
        }
        .alert-urgency.urgent {
            background: #fff7ed;
            color: #ea580c;
        }
        .alert-urgency.warning {
            background: #fffbeb;
            color: #d97706;
        }
        .alert-urgency.info {
            background: #eff6ff;
            color: #2563eb;
        }
        .alert-content {
            flex: 1;
            min-width: 0;
        }
        .alert-message {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
        }
        .alert-type {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            margin-right: 6px;
        }
        .alert-action {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        /* Landlord Group Headers */
        .landlord-group {
            margin-bottom: 32px;
        }
        .landlord-group:last-child {
            margin-bottom: 0;
        }
        .landlord-group-header {
            font-size: 15px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .btn-upload-new {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: #3b82f6;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.15s;
        }
        .btn-upload-new:hover {
            background: #2563eb;
        }

        /* Dashboard Lease Cards - Equal Height */
        .leases-grid .lease-card {
            display: flex;
            flex-direction: column;
            min-height: 220px;
        }
        .lease-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .lease-card-title {
            font-weight: 600;
            font-size: 18px;
            color: #1a1a2e;
            line-height: 1.3;
            margin-bottom: 16px;
        }
        .lease-card-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        .lease-card-meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .lease-card-meta-label {
            color: #9ca3af;
        }
        .lease-card-meta-value {
            color: #374151;
            font-weight: 500;
        }
        .lease-card-meta-value.rent {
            color: #059669;
            font-family: 'SF Mono', Monaco, monospace;
        }

        /* Urgency Block - Prominent Days Display */
        .lease-card-urgency {
            margin-top: auto;
            padding: 14px 12px;
            border-radius: 8px;
            text-align: center;
        }
        .lease-card-urgency .days-value {
            font-size: 28px;
            font-weight: 700;
            line-height: 1.1;
        }
        .lease-card-urgency .days-text {
            font-size: 12px;
            font-weight: 500;
            margin-top: 2px;
        }
        .lease-card-urgency.positive {
            background: #f0fdf4;
            color: #166534;
        }
        .lease-card-urgency.warning {
            background: #fffbeb;
            color: #92400e;
        }
        .lease-card-urgency.critical {
            background: #fef2f2;
            color: #b91c1c;
        }
        .lease-card-urgency.expired {
            background: #fef2f2;
            color: #7f1d1d;
        }
        .lease-card-urgency.no-date {
            background: #f9fafb;
            color: #9ca3af;
            padding: 10px 12px;
        }
        .lease-card-urgency.no-date .days-text {
            font-size: 13px;
        }

        /* Card urgency border accents */
        .leases-grid .lease-card.card-warning {
            border-left: 3px solid #fbbf24;
        }
        .leases-grid .lease-card.card-critical {
            border-left: 3px solid #ef4444;
        }
        .leases-grid .lease-card.card-expired {
            border-left: 4px solid #b91c1c;
        }

        .btn-view-lease {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-top: 16px;
            background: #f8f9fa;
            color: #374151;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }
        .btn-view-lease:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        /* Empty State */
        .dashboard-empty {
            text-align: center;
            padding: 80px 32px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .dashboard-empty h3 {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a2e;
            margin: 0 0 8px 0;
        }
        .dashboard-empty p {
            color: #6b7280;
            margin: 0 0 28px 0;
            font-size: 15px;
            line-height: 1.6;
        }

        /* Dashboard Navigation - Back Link */
        .dashboard-nav {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        .dashboard-nav-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #6b7280;
            text-decoration: none;
            transition: color 0.15s;
            letter-spacing: 0.01em;
        }
        .dashboard-nav-link:hover {
            color: #374151;
        }
        .dashboard-nav-link span {
            font-size: 14px;
            color: #9ca3af;
            transition: color 0.15s;
        }
        .dashboard-nav-link:hover span {
            color: #6b7280;
        }

        /* ======================================== */

        /* Responsive adjustments */
        @media (max-width: 640px) {
            body {
                padding: 24px 16px 40px;
            }
            .card, .upload-form, .confirm-form, .view-section, .upload-item {
                padding: 20px;
            }
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .field-row {
                flex-direction: column;
                gap: 4px;
            }
            .field-label {
                width: 100%;
            }
            .form-buttons {
                flex-wrap: wrap;
            }
            .view-actions {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="page-header">
        <h1>Easemylease</h1>
        <p>Welcome! This app will help you track your lease details.</p>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% if show_dashboard %}
    <!-- DASHBOARD-FIRST VIEW -->
    <div class="leases-dashboard">
        {% if global_alerts and global_alerts|length > 0 %}
        <div class="global-alerts">
            <div class="global-alerts-header">Alerts</div>
            {% for alert in global_alerts %}
            <a href="/?lease_id={{ alert.lease_id }}" class="alert-row">
                <span class="alert-urgency {{ alert.urgency }}">{% if alert.urgency == 'critical' %}Action Required{% elif alert.urgency == 'urgent' %}Attention{% elif alert.urgency == 'warning' %}Upcoming{% else %}Reminder{% endif %}</span>
                <span class="alert-content">
                    <span class="alert-message">
                        <span class="alert-type">{% if alert.type == 'lease_expiry' %}Lease{% else %}Rent{% endif %}</span>{{ alert.message }}
                    </span>
                    <span class="alert-action">{{ alert.lease_nickname }}</span>
                </span>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        {% if leases and leases|length > 0 %}
        <div class="leases-dashboard-header">
            <h3>Your Leases</h3>
            <span class="leases-dashboard-count">{{ leases|length }} lease{% if leases|length != 1 %}s{% endif %}</span>
        </div>
        <div class="dashboard-actions">
            <a href="/?new=true" class="btn-upload-new">+ Upload New Lease</a>
        </div>
        {% for lessor_name, lessor_leases in grouped_leases.items() %}
        <div class="landlord-group">
            <div class="landlord-group-header">{{ lessor_name }}</div>
            <div class="leases-grid">
                {% for lease in lessor_leases %}
                {% set lcv = lease.current_values if lease.current_values else lease %}
                {% set days_remaining = lcv.lease_end_date | days_until %}
                <div class="lease-card {% if days_remaining is not none %}{% if days_remaining < 0 %}card-expired{% elif days_remaining <= 10 %}card-critical{% elif days_remaining <= 30 %}card-warning{% endif %}{% endif %}">
                    <div class="lease-card-content">
                        <div class="lease-card-title">{{ lcv.lease_nickname or 'Untitled Lease' }}</div>
                        <div class="lease-card-meta">
                            <div class="lease-card-meta-row">
                                <span class="lease-card-meta-label">End Date</span>
                                <span class="lease-card-meta-value">{{ lcv.lease_end_date or '' }}</span>
                            </div>
                            <div class="lease-card-meta-row">
                                <span class="lease-card-meta-label">Monthly Rent</span>
                                <span class="lease-card-meta-value rent">{% if lcv.monthly_rent %}{{ lcv.monthly_rent | format_money }}{% else %}{% endif %}</span>
                            </div>
                            <div class="lease-card-meta-row">
                                <span class="lease-card-meta-label">Added</span>
                                <span class="lease-card-meta-value">{{ lease.created_at | format_date }}</span>
                            </div>
                        </div>
                        {% if days_remaining is not none %}
                        <div class="lease-card-urgency {% if days_remaining < 0 %}expired{% elif days_remaining <= 10 %}critical{% elif days_remaining <= 30 %}warning{% else %}positive{% endif %}">
                            <div class="days-value">{% if days_remaining < 0 %}{{ days_remaining | abs }}{% elif days_remaining == 0 %}0{% else %}{{ days_remaining }}{% endif %}</div>
                            <div class="days-text">{% if days_remaining < 0 %}days overdue{% elif days_remaining == 0 %}expires today{% elif days_remaining == 1 %}day left{% else %}days left{% endif %}</div>
                        </div>
                        {% else %}
                        <div class="lease-card-urgency no-date">
                            <div class="days-text">No end date set</div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="lease-card-actions">
                        <a href="/?lease_id={{ lease.id }}" class="btn-view-lease">View Lease</a>
                        <button type="button" class="btn-delete-lease delete-trigger"
                                onclick="openDeleteModal('{{ lease.id }}', '{{ lcv.lease_nickname|e if lcv.lease_nickname else 'Untitled Lease' }}', true)">
                            Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <!-- Empty state -->
        <div class="dashboard-empty">
            <h3>No leases yet</h3>
            <p>Upload a lease document to start tracking<br>important dates and payment reminders.</p>
            <a href="/?new=true" class="btn-upload-new">+ Upload Your First Lease</a>
        </div>
        {% endif %}
    </div>

    {% elif lease_data and not edit_mode %}
    <!-- VIEW MODE: Display saved lease details -->
    {% set cv = lease_data.current_values if lease_data.current_values else lease_data %}

    <!-- Dashboard Navigation - Back Link -->
    <div class="dashboard-nav">
        <a href="/" class="dashboard-nav-link">
            <span></span> All Leases
        </a>
    </div>

    {% if reminder_status and (reminder_status.lease_expiry or reminder_status.rent_payment) %}
    <div class="reminder-card">
        <h3>Reminders</h3>
        <div class="reminder-grid">
            {% if reminder_status.lease_expiry %}
            <div class="reminder-item urgency-{{ reminder_status.lease_expiry.urgency }}">
                <div class="reminder-label">
                    Lease Expiry
                    {% if reminder_status.lease_expiry.urgency != 'none' %}
                    <span class="urgency-badge urgency-{{ reminder_status.lease_expiry.urgency }}">
                        <span class="urgency-icon">{% if reminder_status.lease_expiry.urgency == 'info' %}&#8505;&#65039;{% elif reminder_status.lease_expiry.urgency == 'warning' %}&#9888;&#65039;{% elif reminder_status.lease_expiry.urgency == 'urgent' %}&#128276;{% elif reminder_status.lease_expiry.urgency == 'critical' %}&#128680;{% endif %}</span>{{ reminder_status.lease_expiry.urgency }}
                    </span>
                    {% endif %}
                </div>
                <div class="reminder-days">
                    {% if reminder_status.lease_expiry.days_remaining >= 0 %}
                        {{ reminder_status.lease_expiry.days_remaining }} <span>days left</span>
                    {% else %}
                        {{ reminder_status.lease_expiry.days_remaining|abs }} <span>days overdue</span>
                    {% endif %}
                </div>
                <div class="reminder-message">{{ reminder_status.lease_expiry.message }}</div>
            </div>
            {% endif %}
            {% if reminder_status.rent_payment %}
            <div class="reminder-item urgency-{{ reminder_status.rent_payment.urgency }}">
                <div class="reminder-label">
                    Rent Payment
                    {% if reminder_status.rent_payment.urgency != 'none' %}
                    <span class="urgency-badge urgency-{{ reminder_status.rent_payment.urgency }}">
                        <span class="urgency-icon">{% if reminder_status.rent_payment.urgency == 'info' %}&#8505;&#65039;{% elif reminder_status.rent_payment.urgency == 'warning' %}&#9888;&#65039;{% elif reminder_status.rent_payment.urgency == 'urgent' %}&#128276;{% elif reminder_status.rent_payment.urgency == 'critical' %}&#128680;{% endif %}</span>{{ reminder_status.rent_payment.urgency }}
                    </span>
                    {% endif %}
                </div>
                <div class="reminder-days">
                    {% if reminder_status.rent_payment.days_remaining >= 0 %}
                        {{ reminder_status.rent_payment.days_remaining }} <span>days until due</span>
                    {% else %}
                        {{ reminder_status.rent_payment.days_remaining|abs }} <span>days overdue</span>
                    {% endif %}
                </div>
                <div class="reminder-message">{{ reminder_status.rent_payment.message }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="view-section">
        <h3>Lease Details</h3>

        <!-- Lease Nickname as Title -->
        <div class="lease-title">
            <span class="lease-title-label">Lease Nickname</span>
            {{ cv.lease_nickname or 'Untitled Lease' }}
        </div>

        <div class="lease-added-date">Lease added on: {{ lease_data.created_at | format_date }}</div>

        <!-- SECTION A: Parties -->
        <div class="details-group">
            <h4 class="details-group-header">Parties</h4>
            <div class="field-row">
                <span class="field-label">Lessor / Licensor</span>
                <span class="field-value">{{ cv.lessor_name or '' }}</span>
            </div>
            <div class="field-row">
                <span class="field-label">Lessee / Licensee</span>
                <span class="field-value">{{ cv.lessee_name or '' }}</span>
            </div>
        </div>

        <!-- SECTION B: Key Dates -->
        <div class="details-group">
            <h4 class="details-group-header">Key Dates</h4>
            <div class="field-row">
                <span class="field-label">Lease Start Date</span>
                <span class="field-value value-date">{{ cv.lease_start_date or '' }}</span>
            </div>
            <div class="field-row">
                <span class="field-label">Lease End Date</span>
                <span class="field-value value-date">{{ cv.lease_end_date or '' }}</span>
            </div>
            <div class="field-row">
                <span class="field-label">Rent Due Day</span>
                <span class="field-value value-date">{{ cv.rent_due_day or '' }}{% if cv.rent_due_day %} of each month{% endif %}</span>
            </div>
        </div>

        <!-- SECTION C: Financials -->
        <div class="details-group">
            <h4 class="details-group-header">Financials</h4>
            <div class="field-row">
                <span class="field-label">Monthly Rent</span>
                <span class="field-value value-money">{% if cv.monthly_rent %}{{ cv.monthly_rent | format_money }}{% else %}{% endif %}</span>
            </div>
            <div class="field-row">
                <span class="field-label">Security Deposit</span>
                <span class="field-value value-money">{% if cv.security_deposit %}{{ cv.security_deposit | format_money }}{% else %}{% endif %}</span>
            </div>
        </div>

        <!-- SECTION D: Lease Terms -->
        <div class="details-group">
            <h4 class="details-group-header">Lease Terms</h4>
            <div class="field-row">
                <span class="field-label">Lock-in Period</span>
                <span class="field-value">{% if cv.lock_in_period and cv.lock_in_period.duration_months is not none %}{{ cv.lock_in_period.duration_months }} months{% else %}Not specified{% endif %}</span>
            </div>
            <div class="field-row">
                <span class="field-label">Rent Escalation on Renewal</span>
                <span class="field-value">{% if cv.renewal_terms and cv.renewal_terms.rent_escalation_percent is not none %}{{ cv.renewal_terms.rent_escalation_percent }}%{% else %}Not specified{% endif %}</span>
            </div>
        </div>

        <!-- SECTION E: Changes from Previous Lease (only for renewals) -->
        {% if version_changes and version_changes|length > 0 %}
        <button type="button" class="btn-toggle-changes" onclick="openChangesModal()">
            View changes from previous lease
        </button>
        {% endif %}

        <!-- Metadata -->
        {% set source_doc = lease_data.source_document if lease_data.source_document else {} %}
        <div class="details-meta">
            <div class="field-row">
                <span class="field-label">Source File</span>
                <span class="field-value">{{ source_doc.filename or lease_data.source_filename or '' }}</span>
            </div>
            <div class="field-row">
                <span class="field-label">Last Saved</span>
                <span class="field-value">{{ lease_data.updated_at or lease_data.saved_at or '' }}</span>
            </div>
        </div>

        <div class="view-actions">
            <a href="/?lease_id={{ lease_data.id }}&edit=true" class="btn-edit">Edit Lease</a>
            <a href="/?new=true&renew_from={{ lease_data.id }}" class="btn-renew">Add Renewal Lease</a>
            <button type="button" class="btn-view-text" onclick="openTextModal()">
                View Extracted Text
            </button>
            {% if lease_data.source_document and lease_data.source_document.filename and lease_data.source_document.filename.lower().endswith('.pdf') %}
            <button type="button" class="btn-view-text" onclick="openPdfModal()">
                View Original PDF
            </button>
            {% endif %}
            <button type="button" class="btn-reset delete-trigger"
                    onclick="openDeleteModal('{{ lease_data.id }}', '{{ lease_data.lease_nickname|e if lease_data.lease_nickname else 'Untitled Lease' }}', false)">
                Delete Lease
            </button>
        </div>

        {# ---- LEASE VERSION HISTORY ---- #}
        {% if lease_versions and lease_versions|length > 1 %}
        <div class="version-history" style="margin-top: 24px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
            <div class="version-history-header">
                <h3>Lease Version History</h3>
                <span class="version-count">{{ lease_versions|length }} version{% if lease_versions|length != 1 %}s{% endif %}</span>
            </div>
            <div id="lease-history-collapsed">
                <button type="button" onclick="document.getElementById('lease-history-collapsed').style.display='none';document.getElementById('lease-history-full').style.display='block';" style="background: #2563eb; color: white; border: none; padding: 8px 18px; border-radius: 4px; font-size: 0.9em; cursor: pointer;">View lease history</button>
            </div>
            <div id="lease-history-full" style="display: none;">
            <div class="version-list">
                {% for version in lease_versions %}
                <div class="version-item {% if version.is_current %}current{% else %}previous{% endif %}">
                    <span class="version-badge">v{{ version.version or 1 }}</span>
                    <div class="version-details">
                        <div class="version-detail">
                            <span class="version-detail-label">Start:</span>
                            <span class="version-detail-value">{{ (version.current_values.lease_start_date if version.current_values) or '' }}</span>
                        </div>
                        <div class="version-detail">
                            <span class="version-detail-label">End:</span>
                            <span class="version-detail-value">{{ (version.current_values.lease_end_date if version.current_values) or '' }}</span>
                        </div>
                        <div class="version-detail">
                            <span class="version-detail-label">File:</span>
                            <span class="version-detail-value">{{ (version.source_document.filename if version.source_document) or '' }}</span>
                        </div>
                    </div>
                    <span class="version-status {% if version.is_current %}current{% else %}previous{% endif %}">
                        {% if version.is_current %}Current / Latest{% else %}Previous{% endif %}
                    </span>
                    <div class="version-actions">
                        {% if version.id == lease_data.id %}
                        <span class="btn-view-version viewing">Viewing</span>
                        {% else %}
                        <a href="/?lease_id={{ version.id }}" class="btn-view-version">View</a>
                        {% endif %}
                        <button type="button" class="btn-delete-version"
                                onclick="openVersionDeleteModal('{{ version.id }}', '{{ version.version or 1 }}', {{ 'true' if version.is_current else 'false' }}, {{ lease_versions|length }})">
                            Delete
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="document.getElementById('lease-history-full').style.display='none';document.getElementById('lease-history-collapsed').style.display='block';" style="margin-top: 8px; background: none; border: 1px solid #e5e7eb; padding: 6px 14px; border-radius: 4px; font-size: 0.85em; color: #6b7280; cursor: pointer;">Hide lease history</button>
            </div>
        </div>
        {% endif %}

        {# ---- MONTHLY SUBMISSION SUMMARY (Step 9) ---- #}
        {% if monthly_summary %}
        <div id="monthly-summary" style="margin-top: 24px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
            <h3 style="font-size: 1.1em; margin-bottom: 4px;">Monthly Submission Summary
                {% set ns_attn = namespace(count=0) %}
                {% for ms in monthly_summary %}
                    {% if ms.review_status in ['tenant_replied', 'pending'] %}{% set ns_attn.count = ns_attn.count + 1 %}{% endif %}
                {% endfor %}
                {% if ns_attn.count > 0 %}
                <span style="background: #dbeafe; color: #1e40af; font-size: 0.65em; font-weight: 600; padding: 2px 8px; border-radius: 10px; margin-left: 8px; vertical-align: middle;">{{ ns_attn.count }} need{{ 's' if ns_attn.count == 1 else '' }} attention</span>
                {% endif %}
            </h3>
            <p style="color: #9ca3af; font-size: 0.82em; margin: 0 0 8px 0;">Showing the last 6 months. Older months appear only if they need attention. Click a month to review submissions or respond to tenant messages.</p>
            <div id="monthly-summary-collapsed">
                <button type="button" onclick="document.getElementById('monthly-summary-collapsed').style.display='none';document.getElementById('monthly-summary-full').style.display='block';" style="background: #2563eb; color: white; border: none; padding: 8px 18px; border-radius: 4px; font-size: 0.9em; cursor: pointer;">Show monthly summary</button>
            </div>
            <div id="monthly-summary-full" style="display: none;">
            <style>
                #monthly-summary tr[onclick]:hover { background: #f9fafb; }
                @keyframes gentle-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.65; } }
                #submissionsModalBody.history-view form,
                #submissionsModalBody.history-view details { display: none !important; }
            </style>
            {% set ns_total = namespace(count=0) %}
            {% for ms in monthly_summary %}{% set ns_total.count = ns_total.count + ms.count %}{% endfor %}
            {% if ns_total.count > 0 %}
            <p style="color: #777; font-size: 0.85em; margin: 0 0 12px 0;">
                This summary reflects whether the tenant submitted any declarations for a given month.
                It does not verify payment or completeness.
            </p>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <thead>
                    <tr style="border-bottom: 2px solid #e5e7eb;">
                        <th style="text-align: left; padding: 8px; color: #555;">Month</th>
                        <th style="text-align: left; padding: 8px; color: #555;">Submission Status</th>
                        <th style="text-align: left; padding: 8px; color: #555;">Review Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% set cat_order = ['rent', 'maintenance', 'utilities'] %}
                    {% set cat_labels = {'rent': 'Rent', 'maintenance': 'Maintenance', 'utilities': 'Utilities'} %}
                    {% for ms in monthly_summary %}
                    {% if ms.visible %}
                    <tr style="border-bottom: 1px solid #f3f4f6;{% if ms.count > 0 %} cursor: pointer;{% endif %}"{% if ms.count > 0 %} onclick="openSubmissionsModal({{ ms.month }}, {{ ms.year }}, '{{ ms.month_name }}')"{% endif %}>
                        <td style="padding: 8px; vertical-align: top;">{{ ms.month_name }} {{ ms.year }}</td>

                        {# ---- Submission Status ---- #}
                        <td style="padding: 8px; vertical-align: top;">
                            {% if ms.expected_categories is none %}
                            <span style="color: #d1d5db;"></span>
                            {% elif ms.expected_categories | length == 0 %}
                            <span style="color: #d1d5db;"></span>
                            {% else %}
                                {% for cat in cat_order %}
                                    {% if cat in ms.expected_categories %}
                                    <div style="font-size: 0.85em; line-height: 1.6;">
                                        {% if cat in (ms.covered_categories or []) %}
                                        <span style="color: #16a34a;"></span>
                                        {% else %}
                                        <span style="color: #d1d5db;"></span>
                                        {% endif %}
                                        <span style="color: #555;">{{ cat_labels[cat] }}</span>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </td>

                        {# ---- Review Status ---- #}
                        <td style="padding: 8px; vertical-align: top;">
                            {% if ms.category_details is none %}
                            <span style="color: #d1d5db;"></span>
                            {% elif ms.category_details == {} and ms.count == 0 %}
                            <div style="font-size: 0.85em;">
                                <span style="color: #7c3aed; font-weight: 700; background: #f3e8ff; padding: 2px 8px; border-radius: 4px; animation: gentle-pulse 2s ease-in-out infinite;"> No information submitted by tenant</span>
                            </div>
                            {% else %}
                                {% set all_ack = [] %}
                                {% for cat in cat_order %}
                                    {% if cat in ms.category_details %}
                                        {% if ms.category_details[cat].state == 'acknowledged' %}
                                            {% if all_ack.append(1) %}{% endif %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                {% if all_ack | length == ms.category_details | length and ms.is_complete %}
                                <span style="font-size: 0.85em; color: #16a34a;"> All submitted and acknowledged</span>
                                {% else %}
                                    {% for cat in cat_order %}
                                        {% if cat in ms.category_details %}
                                        {% set cd = ms.category_details[cat] %}
                                        <div style="font-size: 0.85em; line-height: 1.6;">
                                            {% if cd.state == 'tenant_replied' %}
                                            <span style="color: #1e40af;"></span> <span style="color: #1e40af; font-weight: 600;">{{ cat_labels[cat] }}  tenant responded{% if cd.date %} on {{ cd.date | format_date }}{% endif %}, pending your review</span>
                                            {% elif cd.state == 'flagged' %}
                                            {% if cd.flag_date and cd.flag_date == cd.date %}
                                            <span style="color: #92400e;"></span> <span style="color: #92400e; font-weight: 600;">{{ cat_labels[cat] }}  flag raised by you{% if cd.date %} on {{ cd.date | format_date }}{% endif %}, awaiting tenant response</span>
                                            {% else %}
                                            <span style="color: #92400e;"></span> <span style="color: #92400e; font-weight: 600;">{{ cat_labels[cat] }}  you responded to tenant{% if cd.date %} on {{ cd.date | format_date }}{% endif %}, awaiting tenant response</span>
                                            {% endif %}
                                            {% elif cd.state == 'pending_review' %}
                                            <span style="color: #1e40af;"></span> <span style="color: #1e40af; font-weight: 600;">{{ cat_labels[cat] }}  tenant submitted{% if cd.date %} on {{ cd.date | format_date }}{% endif %}, pending your review</span>
                                            {% elif cd.state == 'acknowledged' %}
                                            <span style="color: #16a34a;"></span> <span style="color: #16a34a;">{{ cat_labels[cat] }}  acknowledged  no further action required</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            <p style="color: #aaa; font-size: 0.75em; margin: 6px 0 0 0;">Submissions indicate that the tenant has uploaded documents. They do not confirm payment, accuracy, or landlord approval.</p>
            {% if payment_confirmations %}
            <div style="margin-top: 10px; text-align: center;">
                <a href="javascript:void(0)" onclick="openFullHistoryModal()" style="color: #2563eb; font-size: 0.85em; text-decoration: none; cursor: pointer;">View full submission history</a>
            </div>
            {% endif %}
            {% else %}
            <p style="color: #9ca3af; font-size: 0.9em; text-align: center; padding: 20px 0;">No submissions yet. Tenant payment confirmations will appear here once submitted.</p>
            {% endif %}
            <button type="button" onclick="document.getElementById('monthly-summary-full').style.display='none';document.getElementById('monthly-summary-collapsed').style.display='block';" style="margin-top: 8px; background: none; border: 1px solid #e5e7eb; padding: 6px 14px; border-radius: 4px; font-size: 0.85em; color: #6b7280; cursor: pointer;">Hide monthly summary</button>
            </div>
        </div>
        {% endif %}

        {# ---- PAYMENT SUBMISSIONS SECTION (Step 8) ---- #}
        <div id="payment-submissions" style="display: none; margin-top: 24px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
            <h3 style="font-size: 1.1em; margin-bottom: 4px;">Payment Submissions (Unverified)</h3>
            <p style="color: #777; font-size: 0.85em; margin: 0 0 16px 0;">
                These are tenant-declared submissions. The app does not verify payments.
                Landlords must independently confirm receipts via bank records.
            </p>

            {% if payment_confirmations %}
                {% set ns = namespace(prev_month=None, prev_year=None) %}
                {% for pc in payment_confirmations %}

                {# Month grouping divider #}
                {% if pc.period_month != ns.prev_month or pc.period_year != ns.prev_year %}
                <div style="display: flex; align-items: center; gap: 10px; margin: 16px 0 8px 0;{% if loop.first %} margin-top: 0;{% endif %}">
                    <div style="flex: 1; height: 1px; background: #d1d5db;"></div>
                    <span style="color: #6b7280; font-size: 0.8em; font-variant: small-caps; letter-spacing: 0.05em; white-space: nowrap;">
                        {{ ["January","February","March","April","May","June","July","August","September","October","November","December"][pc.period_month - 1] if pc.period_month else '?' }}
                        {{ pc.period_year or '' }}
                    </span>
                    <div style="flex: 1; height: 1px; background: #d1d5db;"></div>
                </div>
                {% set ns.prev_month = pc.period_month %}
                {% set ns.prev_year = pc.period_year %}
                {% endif %}

                <div data-period-month="{{ pc.period_month }}" data-period-year="{{ pc.period_year }}" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 14px 16px; margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
                        <span style="background: #6b7280; color: white; font-size: 0.75em; padding: 2px 8px; border-radius: 10px;">Unverified</span>
                        <span style="font-weight: 600; font-size: 0.9em;">
                            {{ pc.confirmation_type|capitalize if pc.confirmation_type else 'Unknown' }}
                        </span>
                        <span style="color: #777; font-size: 0.85em;">
                            {{ ["January","February","March","April","May","June","July","August","September","October","November","December"][pc.period_month - 1] if pc.period_month else '?' }}
                            {{ pc.period_year or '' }}
                        </span>
                        {% set same_period = payment_confirmations|selectattr('confirmation_type', 'equalto', pc.confirmation_type)|selectattr('period_month', 'equalto', pc.period_month)|selectattr('period_year', 'equalto', pc.period_year)|list %}
                        {% if same_period|length > 1 %}
                        <span style="background: #fef3c7; color: #92400e; font-size: 0.7em; padding: 2px 8px; border-radius: 10px;">Multiple submissions this period</span>
                        {% endif %}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px 16px; font-size: 0.9em;">
                        <div><span style="color: #777;">Amount paid:</span> <strong>{{ "{:,.0f}".format(pc.amount_declared|float) if pc.amount_declared else '' }}</strong></div>
                        {% if pc.confirmation_type == 'rent' and pc.amount_agreed %}
                        <div><span style="color: #777;">Agreed rent:</span> {{ "{:,.0f}".format(pc.amount_agreed|float) }}</div>
                        {% endif %}
                        {% if pc.tds_deducted is not none %}
                        <div><span style="color: #777;">TDS deducted:</span> {{ "{:,.0f}".format(pc.tds_deducted|float) }}</div>
                        {% endif %}
                        {% if pc.date_paid %}
                        <div><span style="color: #777;">Date paid:</span> {{ pc.date_paid }}</div>
                        {% endif %}
                        <div><span style="color: #777;">Submitted:</span> {{ pc.submitted_at[:16]|replace('T', ' ') if pc.submitted_at else '' }}</div>
                        <div><span style="color: #777;">Via:</span> {{ pc.submitted_via|replace('_', ' ')|capitalize if pc.submitted_via else '' }}</div>
                    </div>

                    {% if pc.notes %}
                    <div style="margin-top: 8px; font-size: 0.85em; color: #555;">
                        <span style="color: #777;">Notes:</span> {{ pc.notes }}
                    </div>
                    {% endif %}

                    {% if pc.proof_files and pc.proof_files|length > 0 %}
                    <div style="margin-top: 8px; font-size: 0.85em;">
                        <span style="color: #777;">Proof:</span>
                        {% for pf in pc.proof_files %}
                            {% set filename = pf.split('/')[-1] %}
                            <a href="{{ url_for('view_proof', lease_group_id=pc.lease_group_id, filename=filename) }}" target="_blank" style="color: #2563eb; margin-left: 4px;">{{ filename }}</a>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# ---- LANDLORD REVIEW / CONVERSATION BLOCK (Phase 2) ---- #}
                    {% set pc_events = payment_events.get(pc.id, []) %}
                    {% set convo = payment_conversation.get(pc.id, {"open": False, "thread": []}) %}

                    <div style="margin-top: 10px; padding-top: 8px; border-top: 1px dashed #d1d5db;">

                    {# ---- Event timeline ---- #}
                    {% if pc_events %}
                    <div style="margin-bottom: 10px;">
                        <span style="font-size: 0.85em; color: #777;">Review history</span>
                        {% for ev in pc_events %}
                        <div style="margin-top: 6px; padding: 8px 10px; background: {% if ev.actor == 'tenant' %}#f0f9ff{% else %}#f9fafb{% endif %}; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 0.85em;{% if ev.event_type in ('acknowledged', 'noted') %} opacity: 0.75;{% endif %}{# noted kept for historical data #}">
                            <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                                {% if ev.actor == 'tenant' %}
                                <span style="background: #dbeafe; color: #1e40af; font-size: 0.8em; padding: 1px 6px; border-radius: 8px;">Tenant</span>
                                {% else %}
                                <span style="background: #f3f4f6; color: #374151; font-size: 0.8em; padding: 1px 6px; border-radius: 8px;">Landlord</span>
                                {% endif %}
                                {% if ev.event_type in ('acknowledged', 'noted') %}
                                <span style="background: #d1fae5; color: #065f46; font-size: 0.8em; padding: 1px 6px; border-radius: 8px;">Acknowledged</span>
                                {% elif ev.event_type == 'flagged' %}
                                <span style="background: #fef3c7; color: #92400e; font-size: 0.8em; padding: 1px 6px; border-radius: 8px;">Flagged</span>
                                {% elif ev.event_type == 'response' %}
                                <span style="background: #e0e7ff; color: #3730a3; font-size: 0.8em; padding: 1px 6px; border-radius: 8px;">Reply</span>
                                {% endif %}
                                <span style="color: #999; font-size: 0.85em;">{{ ev.created_at[:16]|replace('T', ' ') if ev.created_at else '' }}</span>
                            </div>
                            {% if ev.message %}
                            <div style="margin-top: 4px; color: #555;">{{ ev.message }}</div>
                            {% endif %}
                            {% if ev.attachments %}
                            <div style="margin-top: 4px;">
                                {% for att in ev.attachments %}
                                {% set att_filename = att.split('/')[-1] %}
                                <a href="{{ url_for('view_proof', lease_group_id=pc.lease_group_id, filename=att_filename) }}" target="_blank" style="color: #2563eb; font-size: 0.85em;">{{ att_filename }}</a>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {# ---- Actions depend on conversation state ---- #}
                    {% if convo.open %}
                    {# ---- CONVERSATION OPEN: Reply + Close actions ---- #}
                    <div style="margin-top: 8px;">
                        <form method="POST" action="{{ url_for('submit_payment_review', lease_group_id=pc.lease_group_id, payment_id=pc.id) }}" enctype="multipart/form-data" style="margin-bottom: 10px;">
                            <input type="hidden" name="review_type" value="response">
                            <div style="margin-bottom: 6px;">
                                <label style="font-size: 0.85em; color: #555; display: block; margin-bottom: 4px;">Reply to tenant</label>
                                <textarea name="internal_note" rows="2" placeholder="Type your reply..." required style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em; resize: vertical;"></textarea>
                            </div>
                            <div style="margin-bottom: 6px;">
                                <label style="font-size: 0.8em; color: #777; display: block; margin-bottom: 2px;">Attachment (optional)</label>
                                <input type="file" name="attachment" accept=".png,.jpg,.jpeg,.pdf" style="font-size: 0.85em;">
                            </div>
                            <button type="submit" style="background: #2563eb; color: white; border: none; padding: 6px 16px; border-radius: 4px; font-size: 0.85em; cursor: pointer;">Send reply</button>
                        </form>

                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: flex-start;">
                            <form method="POST" action="{{ url_for('submit_payment_review', lease_group_id=pc.lease_group_id, payment_id=pc.id) }}" style="margin: 0;">
                                <input type="hidden" name="review_type" value="acknowledged">
                                <button type="submit" style="background: #d1fae5; color: #065f46; border: 1px solid #86efac; padding: 5px 12px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">Acknowledge</button>
                            </form>
                        </div>
                    </div>

                    {% else %}
                    {# ---- NO OPEN CONVERSATION: Standard review form ---- #}
                    <details style="margin-top: {% if pc_events %}6{% else %}0{% endif %}px;">
                        <summary style="font-size: 0.8em; color: #2563eb; cursor: pointer;">Review this submission</summary>
                        <p style="font-size: 0.8em; color: #999; margin: 6px 0 8px 0;">
                            Once a note is saved, it can't be changed or removed.
                            If you need to add more context later, just add another note  the most recent one will appear first.
                        </p>
                        <form method="POST" action="{{ url_for('submit_payment_review', lease_group_id=pc.lease_group_id, payment_id=pc.id) }}" enctype="multipart/form-data" style="margin-top: 8px;">
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 0.85em; color: #555; display: block; margin-bottom: 4px;">Review type</label>
                                <select name="review_type" required onchange="toggleFlagWarning(this)" style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                    <option value="acknowledged">Acknowledge</option>
                                    <option value="flagged">Raise a flag</option>
                                </select>
                                <div style="font-size: 0.8em; color: #777; margin-top: 4px; line-height: 1.5;">
                                    Acknowledge  no further action required<br>
                                    Raise a flag  shown to the tenant (comment required)
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 0.85em; color: #555; display: block; margin-bottom: 4px;">Note</label>
                                <textarea name="internal_note" rows="2" placeholder="Add a note..." style="width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em; resize: vertical;"></textarea>
                                <span class="flag-warning" style="display: none; font-size: 0.8em; color: #92400e; margin-top: 4px;">This message will be shown to the tenant.</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <label style="font-size: 0.8em; color: #777; display: block; margin-bottom: 2px;">Attachment (optional)</label>
                                <input type="file" name="attachment" accept=".png,.jpg,.jpeg,.pdf" style="font-size: 0.85em;">
                            </div>
                            <button type="submit" style="background: #374151; color: white; border: none; padding: 6px 16px; border-radius: 4px; font-size: 0.85em; cursor: pointer;">Save review</button>
                        </form>
                    </details>
                    {% endif %}

                    </div>

                </div>
                {% endfor %}
            {% else %}
                <p style="color: #999; font-size: 0.9em; font-style: italic;">No payment submissions have been recorded yet.</p>
            {% endif %}
        </div>

        {# ---- TENANT ACCESS SECTION (Step 7) ---- #}
        <div class="tenant-access-section" style="margin-top: 24px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
            <h3 style="font-size: 1.1em; margin-bottom: 12px;">Tenant Access</h3>

            <div id="tenant-access-collapsed">
                <p style="color: #555; font-size: 0.9em; margin: 0 0 12px 0;">Generate a secure link for your tenant to submit payment confirmations.</p>
                <button type="button" onclick="document.getElementById('tenant-access-collapsed').style.display='none';document.getElementById('tenant-access-full').style.display='block';" style="background: #2563eb; color: white; border: none; padding: 8px 18px; border-radius: 4px; font-size: 0.9em; cursor: pointer;">View tenant access</button>
            </div>

            <div id="tenant-access-full" style="display: none;">
            {% if active_tenant_token %}
            {# ACTIVE TOKEN STATE #}
            <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 6px; padding: 16px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="background: #16a34a; color: white; font-size: 0.75em; padding: 2px 8px; border-radius: 10px;">Active</span>
                    <span style="color: #777; font-size: 0.85em;">Issued {{ active_tenant_token.issued_at[:10] }}</span>
                </div>
                <p style="color: #555; font-size: 0.9em; margin: 0 0 8px 0;">Anyone with this link can submit payment confirmations for this lease.</p>

                <div style="margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 0.9em;">Token: </span>
                    <code id="tenant-token-masked" style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px;">****{{ active_tenant_token.token[-8:] }}</code>
                    <code id="tenant-token-full" style="background: #f3f4f6; padding: 2px 6px; border-radius: 3px; display: none;">{{ active_tenant_token.token }}</code>
                    <button type="button" onclick="var m=document.getElementById('tenant-token-masked'),f=document.getElementById('tenant-token-full');if(f.style.display==='none'){f.style.display='inline';m.style.display='none';this.textContent='Hide'}else{f.style.display='none';m.style.display='inline';this.textContent='Reveal'}" style="background:none;border:1px solid #ccc;padding:2px 8px;border-radius:3px;font-size:0.85em;cursor:pointer;margin-left:4px;">Reveal</button>
                </div>

                <div style="margin-bottom: 12px;">
                    <span style="font-weight: 600; font-size: 0.9em;">Tenant URL: </span>
                    <input type="text" id="tenant-url" readonly value="{{ request.host_url }}tenant/{{ active_tenant_token.token }}" style="width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.85em; margin-top: 4px; background: #f9fafb;">
                    <button type="button" onclick="var u=document.getElementById('tenant-url');u.select();document.execCommand('copy');this.textContent='Copied!';setTimeout(function(){document.querySelector('#copy-link-btn').textContent='Copy link'},2000)" id="copy-link-btn" style="margin-top: 4px; background: #2563eb; color: white; border: none; padding: 6px 14px; border-radius: 4px; font-size: 0.85em; cursor: pointer;">Copy link</button>
                </div>

                <details style="margin-top: 12px; border-top: 1px solid #e5e7eb; padding-top: 12px;">
                    <summary style="cursor: pointer; color: #dc2626; font-weight: 600; font-size: 0.9em;">Revoke Tenant Access</summary>
                    <form method="POST" action="{{ url_for('revoke_token_route', lease_group_id=lease_data.lease_group_id) }}" style="margin-top: 8px;">
                        <input type="hidden" name="token" value="{{ active_tenant_token.token }}">
                        <label style="display: block; font-size: 0.85em; color: #555; margin-bottom: 4px;">Reason (optional):</label>
                        <input type="text" name="revoke_reason" placeholder="e.g. Tenant changed" style="width: 100%; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; margin-bottom: 8px;">
                        <button type="submit" style="background: #dc2626; color: white; border: none; padding: 6px 14px; border-radius: 4px; font-size: 0.85em; cursor: pointer;">Revoke Access</button>
                    </form>
                </details>
            </div>

            {% else %}
            {# NO ACTIVE TOKEN STATE #}
            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; margin-bottom: 12px;">
                <p style="color: #555; font-size: 0.9em; margin: 0 0 12px 0;">No tenant access link has been generated yet.</p>
                <form method="POST" action="{{ url_for('generate_token_route', lease_group_id=lease_data.lease_group_id) }}">
                    <button type="submit" style="background: #2563eb; color: white; border: none; padding: 8px 18px; border-radius: 4px; font-size: 0.9em; cursor: pointer;">Generate Tenant Link</button>
                </form>
            </div>
            {% endif %}

            {# REVOKED TOKENS (shown muted) #}
            {% set revoked_tokens = tenant_tokens|selectattr('is_active', 'equalto', false)|list %}
            {% if revoked_tokens %}
            <details style="margin-top: 8px;">
                <summary style="cursor: pointer; color: #777; font-size: 0.85em;">Previous access links ({{ revoked_tokens|length }})</summary>
                {% for rt in revoked_tokens %}
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px 12px; margin-top: 8px; opacity: 0.7;">
                    <span style="background: #9ca3af; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px;">Revoked</span>
                    <span style="color: #777; font-size: 0.8em; margin-left: 6px;">Issued {{ rt.issued_at[:10] }}</span>
                    {% if rt.revoked_at %}
                    <span style="color: #777; font-size: 0.8em; margin-left: 6px;">Revoked {{ rt.revoked_at[:10] }}</span>
                    {% endif %}
                    {% if rt.revoked_reason %}
                    <span style="color: #777; font-size: 0.8em; display: block; margin-top: 4px;">Reason: {{ rt.revoked_reason }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </details>
            {% endif %}
            </div>
        </div>

    </div>

    {% elif edit_mode %}
    <!-- EDIT MODE: Form pre-filled with existing data -->
    <div class="dashboard-nav">
        <a href="{% if lease_data.status == 'active' %}/?lease_id={{ lease_data.id }}{% else %}/{% endif %}" class="dashboard-nav-link">
            <span></span> {% if lease_data.status == 'active' %}Back to Lease{% else %}Back{% endif %}
        </a>
    </div>
    <div class="confirm-form">
        <h3>Edit Lease Details</h3>
        <p>Update the lease details below.</p>

        <!-- Extracted text reference panel -->
        {% set source_doc = lease_data.source_document if lease_data.source_document else {} %}
        {% set extracted_text = source_doc.extracted_text if source_doc else None %}
        {% set cv = lease_data.current_values if lease_data.current_values else lease_data %}
        <div class="text-reference">
            <label>Extracted Text (read-only reference)</label>
            {% if extracted_text %}
                <textarea class="full-text-box" readonly>{{ extracted_text }}</textarea>
            {% else %}
                <textarea class="full-text-box" readonly>No extracted text available.</textarea>
            {% endif %}
        </div>

        <form action="{{ url_for('save_lease') }}" method="post" data-version-changes='{{ version_changes | tojson | e }}' data-lease-version="{{ lease_data.version or 1 }}">
            <input type="hidden" name="lease_id" value="{{ lease_data.id }}">

            <div class="form-group">
                <label for="lease_nickname">Lease Nickname</label>
                <input type="text" id="lease_nickname" name="lease_nickname" placeholder="e.g., Main Apartment" value="{{ cv.lease_nickname or '' }}">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="lessor_name">Lessor / Licensor Name</label>
                    <input type="text" id="lessor_name" name="lessor_name" placeholder="Landlord name" value="{{ cv.lessor_name or '' }}">
                </div>
                <div class="form-group">
                    <label for="lessee_name">Lessee / Licensee Name</label>
                    <input type="text" id="lessee_name" name="lessee_name" placeholder="Tenant name" value="{{ cv.lessee_name or '' }}">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="lease_start_date">Lease Start Date</label>
                    <input type="date" id="lease_start_date" name="lease_start_date" value="{{ cv.lease_start_date or '' }}" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="lease_end_date">Lease End Date</label>
                    <input type="date" id="lease_end_date" name="lease_end_date" value="{{ cv.lease_end_date or '' }}" autocomplete="off">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="monthly_rent">Monthly Rent</label>
                    <input type="number" id="monthly_rent" name="monthly_rent" placeholder="0" min="0" value="{{ cv.monthly_rent or '' }}">
                </div>
                <div class="form-group">
                    <label for="security_deposit">Security Deposit</label>
                    <input type="number" id="security_deposit" name="security_deposit" placeholder="0" min="0" value="{{ cv.security_deposit or '' }}">
                </div>
                <div class="form-group">
                    <label for="lock_in_months">Lock-in Period (months)</label>
                    <input type="number" id="lock_in_months" name="lock_in_months" placeholder="0" min="0" value="{{ (cv.lock_in_period.duration_months if cv.lock_in_period else '') or '' }}">
                </div>
                <div class="form-group">
                    <label for="rent_escalation_percent">Rent Escalation on Renewal (%)</label>
                    <input type="number" id="rent_escalation_percent" name="rent_escalation_percent" placeholder="0" min="0" step="0.1" value="{{ (cv.renewal_terms.rent_escalation_percent if cv.renewal_terms else '') or '' }}">
                </div>
            </div>

            <div class="form-group" style="max-width: 200px;">
                <label for="rent_due_day">Rent Due Day (1-31)</label>
                <input type="number" id="rent_due_day" name="rent_due_day" placeholder="1" min="1" max="31" value="{{ cv.rent_due_day or '' }}">
            </div>

            <!-- Expected Monthly Payments section -->
            <div class="expected-payments-section" style="margin-top: 1.5rem; padding: 1rem; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa;">
                <h4 style="margin: 0 0 0.25rem 0; font-size: 1rem;">Expected Monthly Payments</h4>
                <p style="margin: 0 0 1rem 0; color: #666; font-size: 0.85rem;">What payments is the tenant expected to make each month?</p>

                {% if lease_data.needs_expected_payment_confirmation %}
                <div style="padding: 0.6rem 0.8rem; margin-bottom: 1rem; background: #e8f4fd; border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 0.85rem; color: #1e40af;">
                    This lease was renewed. Please review the expected payment categories below and save to confirm.
                </div>
                {% endif %}

                {% set ep = cv.expected_payments if cv.expected_payments else [] %}
                {% set ep_maintenance = ep | selectattr('type', 'equalto', 'maintenance') | first if ep else none %}
                {% set ep_utilities = ep | selectattr('type', 'equalto', 'utilities') | first if ep else none %}

                <!-- Rent (always expected, not toggleable) -->
                <div style="padding: 0.5rem 0; color: #444; font-size: 0.9rem;">
                    <strong>Rent</strong>  Always expected
                    {% if cv.monthly_rent %}
                        <span style="color: #888;">({{ cv.monthly_rent | format_money }}/month)</span>
                    {% endif %}
                </div>

                <!-- Maintenance (optional) -->
                <div style="padding: 0.5rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.4rem; font-size: 0.9rem; cursor: pointer;">
                        <input type="checkbox" name="expect_maintenance" value="1"
                               onchange="document.getElementById('maintenanceAmountGroup').style.display = this.checked ? 'block' : 'none';"
                               {% if ep_maintenance and ep_maintenance.expected %}checked{% endif %}>
                        <strong>Maintenance</strong>  Tenant pays maintenance
                    </label>
                    <div id="maintenanceAmountGroup" style="display: {% if ep_maintenance and ep_maintenance.expected %}block{% else %}none{% endif %}; margin: 0.4rem 0 0 1.6rem;">
                        <label for="maintenance_amount" style="font-size: 0.85rem; color: #555;">Amount ()</label>
                        <input type="number" id="maintenance_amount" name="maintenance_amount" placeholder="Optional" min="0" step="0.01"
                               value="{{ ep_maintenance.typical_amount if ep_maintenance and ep_maintenance.typical_amount else '' }}"
                               style="max-width: 180px; display: block; margin-top: 0.2rem;">
                        <span style="font-size: 0.8rem; color: #888;">If you're unsure or the amount varies significantly, you can leave this blank.</span>
                    </div>
                </div>

                <!-- Utilities (optional, no amount) -->
                <div style="padding: 0.5rem 0;">
                    <label style="display: flex; align-items: center; gap: 0.4rem; font-size: 0.9rem; cursor: pointer;">
                        <input type="checkbox" name="expect_utilities" value="1"
                               {% if ep_utilities and ep_utilities.expected %}checked{% endif %}>
                        <strong>Utilities</strong>  Tenant pays utilities
                    </label>
                    <span style="margin-left: 1.6rem; font-size: 0.8rem; color: #888; display: block;">Utility amounts change each month, so we just track whether the tenant has submitted proof  no fixed amount needed.</span>
                </div>
            </div>

            <div class="form-buttons">
                <button type="submit">Save Changes</button>
                <button type="button" class="btn-ai" onclick="aiPrefill(this)"> Auto-fill using AI</button>
                <button type="button" class="btn-ai" id="btnReturnPreview" style="display:none;" onclick="reopenAiPreview()">Return to AI Preview</button>
                <a href="{% if lease_data.status == 'active' %}/?lease_id={{ lease_data.id }}{% else %}/{% endif %}" class="btn-cancel">Cancel</a>
            </div>
            <div class="ai-message"></div>
            <div class="unified-changes-container" id="unifiedChanges"></div>
        </form>
    </div>

    <script>
    var hasUnsavedChanges = false;
    (function() {
        var form = document.querySelector('form[action*="save_lease"]');
        if (!form) return;

        form.addEventListener('input', function() { hasUnsavedChanges = true; });
        form.addEventListener('change', function() { hasUnsavedChanges = true; });
        form.addEventListener('submit', function() { hasUnsavedChanges = false; });

        var exitLinks = document.querySelectorAll('.dashboard-nav-link, .btn-cancel');
        exitLinks.forEach(function(link) {
            link.addEventListener('click', function(e) {
                if (hasUnsavedChanges) {
                    if (!confirm('You have unsaved changes. Leave without saving?')) {
                        e.preventDefault();
                    }
                }
            });
        });
    })();
    </script>

    {% else %}
    <!-- NO LEASE: Upload form + confirmation flow -->
    {% if leases and leases|length > 0 %}
    <div class="dashboard-nav">
        <a href="/" class="dashboard-nav-link">
            <span></span> Back
        </a>
    </div>
    {% endif %}
    <div class="upload-form">
        {% if renew_from_lease %}
        <h3>Upload Renewal Lease</h3>
        <p class="renewal-context">Renewing: <strong>{{ renew_from_lease.lease_nickname or 'Untitled Lease' }}</strong> (Version {{ renew_from_lease.version or 1 }})</p>
        <p>Supported formats: PDF, PNG, JPG, JPEG</p>
        {% else %}
        <h3>Upload Your Lease Document</h3>
        <p>Supported formats: PDF, PNG, JPG, JPEG</p>
        {% endif %}
        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
            {% if renew_from %}
            <input type="hidden" name="renew_from" value="{{ renew_from }}">
            {% endif %}
            <div class="upload-zone">
                <input type="file" name="file" accept=".pdf,.png,.jpg,.jpeg" required>
                <br>
                <button type="submit">{% if renew_from %}Upload Renewal{% else %}Upload File{% endif %}</button>
            </div>
        </form>
    </div>

    {% if uploads %}
    {% set latest = uploads | list | last %}
    {% set data = uploads[latest] %}
    <div class="uploads-section">
        <h3>Uploaded File</h3>
        <div class="upload-item">
            <h4>{{ latest }}</h4>
            <div class="file-type">Type: {{ data.mimetype }}</div>

            <!-- Full extracted text reference -->
            <div class="text-reference">
                <label>Extracted Text (read-only reference)</label>
                {% if data.extracted_text %}
                    <textarea class="full-text-box" readonly>{{ data.extracted_text }}</textarea>
                {% else %}
                    <textarea class="full-text-box" readonly placeholder="No text extracted">{{ data.extracted_text or '' }}</textarea>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Confirmation form -->
    <div class="confirm-form">
        <h3>Confirm Lease Details</h3>
        <p>Review the extracted text above and fill in the lease details below.</p>

        <form action="{{ url_for('save_lease') }}" method="post">
            <input type="hidden" name="source_filename" value="{{ latest }}">

            <div class="form-group">
                <label for="lease_nickname">Lease Nickname</label>
                <input type="text" id="lease_nickname" name="lease_nickname" placeholder="e.g., Main Apartment">
                <div class="ai-hint" id="nickname-ai-hint">Suggested by AI  you can edit this freely.</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="lessor_name">Lessor / Licensor Name</label>
                    <input type="text" id="lessor_name" name="lessor_name" placeholder="Landlord name">
                </div>
                <div class="form-group">
                    <label for="lessee_name">Lessee / Licensee Name</label>
                    <input type="text" id="lessee_name" name="lessee_name" placeholder="Tenant name">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="lease_start_date">Lease Start Date</label>
                    <input type="date" id="lease_start_date" name="lease_start_date" value="" autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="lease_end_date">Lease End Date</label>
                    <input type="date" id="lease_end_date" name="lease_end_date" value="" autocomplete="off">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="monthly_rent">Monthly Rent</label>
                    <input type="number" id="monthly_rent" name="monthly_rent" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label for="security_deposit">Security Deposit</label>
                    <input type="number" id="security_deposit" name="security_deposit" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label for="lock_in_months">Lock-in Period (months)</label>
                    <input type="number" id="lock_in_months" name="lock_in_months" placeholder="0" min="0">
                </div>
                <div class="form-group">
                    <label for="rent_escalation_percent">Rent Escalation on Renewal (%)</label>
                    <input type="number" id="rent_escalation_percent" name="rent_escalation_percent" placeholder="0" min="0" step="0.1">
                </div>
            </div>

            <div class="form-group" style="max-width: 200px;">
                <label for="rent_due_day">Rent Due Day (1-31)</label>
                <input type="number" id="rent_due_day" name="rent_due_day" placeholder="1" min="1" max="31">
            </div>

            <div class="form-buttons">
                <button type="submit">Save Lease Details</button>
                <button type="button" class="btn-ai" onclick="aiPrefill(this)"> Auto-fill using AI</button>
            </div>
            <div class="ai-message"></div>
            <div class="ai-summary" id="ai-summary">
                <div class="ai-summary-title">AI Assistance</div>
                <ul>
                    <li>Some fields were pre-filled using AI analysis of your document.</li>
                    <li>You have full control  edit any value freely.</li>
                    <li>Please review all fields before saving.</li>
                </ul>
            </div>
        </form>
    </div>
    {% endif %}
    {% endif %}

<script>
// ========================================
// AI AUTOFILL - TRANSPARENT OVERWRITE
// ========================================

// Track fields manually edited by the user (per form)
const manuallyEditedFields = new WeakMap();

// Field display names for user-friendly messages
const FIELD_LABELS = {
    'lease_nickname': 'Lease Nickname',
    'lessor_name': 'Lessor Name',
    'lessee_name': 'Lessee Name',
    'lease_start_date': 'Start Date',
    'lease_end_date': 'End Date',
    'monthly_rent': 'Monthly Rent',
    'security_deposit': 'Security Deposit',
    'rent_due_day': 'Rent Due Day',
    'lock_in_months': 'Lock-in Period (months)',
    'rent_escalation_percent': 'Rent Escalation on Renewal (%)'
};

// List of all lease fields
const LEASE_FIELDS = Object.keys(FIELD_LABELS);

// Money fields (for display formatting in preview)
const MONEY_PREVIEW_FIELDS = ['monthly_rent', 'security_deposit'];

// AI suggestions waiting for user review (not yet applied to form)
let pendingSuggestions = {};

// Reference to the form that triggered AI (needed by applyAiPreview)
let aiPreviewSourceForm = null;

// Whether AI has been applied (prevents re-running)
let aiHasBeenApplied = false;

// Snapshot of accepted preview state (for reopening preview later)
let acceptedPreviewState = {};

// Track which fields the user edited inside the preview modal
let previewEditedFields = new Set();

// Fields AI did not return a suggestion for (with reason)
let aiNotFilledFields = [];
let aiNotFilledReason = '';

// Global loading overlay control
function setLoading(isLoading, message) {
    const overlay = document.getElementById('globalLoadingOverlay');
    const msgEl = document.getElementById('globalLoadingMessage');
    if (isLoading) {
        msgEl.textContent = message || '';
        overlay.classList.add('visible');
    } else {
        overlay.classList.remove('visible');
        msgEl.textContent = '';
    }
}

// Open AI Suggestions Preview Modal
function openAiPreviewModal(form) {
    const keys = Object.keys(pendingSuggestions);
    if (keys.length === 0) return; // Nothing to preview

    aiPreviewSourceForm = form;
    previewEditedFields = new Set();

    const container = document.getElementById('aiPreviewFields');
    container.innerHTML = '';

    keys.forEach(fieldName => {
        const s = pendingSuggestions[fieldName];

        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'ai-preview-field';

        const label = document.createElement('div');
        label.className = 'ai-preview-label';
        label.textContent = s.label;
        fieldDiv.appendChild(label);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'ai-preview-input';
        input.dataset.fieldName = fieldName;
        input.value = s.newValue;

        // Track edits: change background when user modifies the input
        input.addEventListener('input', function() {
            previewEditedFields.add(fieldName);
            input.classList.add('preview-edited');
        });

        fieldDiv.appendChild(input);

        // Show "Previously entered" hint ONLY if the field had a value before
        if (s.oldValue && s.oldValue.trim() !== '') {
            const hint = document.createElement('div');
            hint.className = 'ai-preview-hint';
            hint.textContent = 'Previously entered: ' + s.oldValue;
            fieldDiv.appendChild(hint);
        }

        container.appendChild(fieldDiv);
    });

    // Render "not found" fields section (empty inputs for user to fill manually)
    if (aiNotFilledFields.length > 0) {
        const section = document.createElement('div');
        section.className = 'ai-preview-notfound-section';

        const heading = document.createElement('div');
        heading.className = 'ai-preview-notfound-heading';
        heading.textContent = 'Fields not found by AI';
        section.appendChild(heading);

        if (aiNotFilledReason) {
            const reasonEl = document.createElement('div');
            reasonEl.className = 'ai-preview-notfound-reason';
            reasonEl.textContent = aiNotFilledReason;
            section.appendChild(reasonEl);
        }

        aiNotFilledFields.forEach(f => {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'ai-preview-field';

            const label = document.createElement('div');
            label.className = 'ai-preview-label';
            label.textContent = f.label;
            fieldDiv.appendChild(label);

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'ai-preview-input preview-notfound';
            input.dataset.fieldName = f.fieldName;
            input.dataset.notFound = 'true';
            input.value = '';
            input.placeholder = 'Enter manually if known';

            input.addEventListener('input', function() {
                previewEditedFields.add(f.fieldName);
                input.classList.add('preview-edited');
            });

            fieldDiv.appendChild(input);
            section.appendChild(fieldDiv);
        });

        container.appendChild(section);
    }

    // Set PDF link using the filename already available on the page
    const pdfLink = document.getElementById('aiPreviewPdfLink');
    const filename = '{{ lease_data.source_document.filename if lease_data and lease_data.source_document and lease_data.source_document.filename else "" }}';
    if (filename) {
        pdfLink.href = '/view_pdf/' + encodeURIComponent(filename);
        pdfLink.style.display = '';
    } else {
        pdfLink.style.display = 'none';
    }

    document.getElementById('aiPreviewModal').classList.add('visible');
}

// Close AI Suggestions Preview Modal (Cancel  discard everything)
function closeAiPreviewModal() {
    document.getElementById('aiPreviewModal').classList.remove('visible');
    aiPreviewSourceForm = null;
    previewEditedFields = new Set();
}

// Apply Changes: write preview values into the real form
function applyAiPreview() {
    if (!aiPreviewSourceForm) return;

    const form = aiPreviewSourceForm;
    const inputs = document.querySelectorAll('#aiPreviewFields .ai-preview-input');

    // Track the four cases for the post-apply summary
    const caseA = []; // AI suggested, accepted unchanged
    const caseB = []; // AI suggested, user edited
    const caseC = []; // AI did not suggest, user entered manually
    const caseD = []; // AI did not suggest, still empty

    inputs.forEach(input => {
        const fieldName = input.dataset.fieldName;
        const previewValue = input.value.trim();
        const isNotFound = input.dataset.notFound === 'true';
        const field = form.querySelector('[name="' + fieldName + '"]');
        if (!field) return;

        const label = isNotFound
            ? (aiNotFilledFields.find(f => f.fieldName === fieldName) || {}).label || fieldName
            : pendingSuggestions[fieldName].label;

        if (isNotFound) {
            // Field AI did NOT suggest
            if (previewValue === '') {
                // Case D: still empty
                caseD.push(label);
                field.dataset.aiNotFound = 'true';
            } else {
                // Case C: user entered manually
                caseC.push(label);
                field.value = previewValue;
                delete field.dataset.aiNotFound;
                field.classList.add('user-edited');
                field.classList.remove('ai-filled');
                field.dataset.overwriteSource = 'user';
                field.dataset.previousValue = '';
                field.dataset.overwrittenAt = new Date().toISOString();

                // Add to unified changes map (renewals only)
                if (parseInt(form.dataset.leaseVersion) > 1) {
                    unifiedChangesMap[fieldName] = {
                        field: fieldName,
                        label: label,
                        oldValue: '',
                        newValue: previewValue,
                        changeType: 'added',
                        source: 'user'
                    };
                }
            }
        } else {
            // Field AI DID suggest
            if (previewValue === '') return; // User cleared it  skip

            const oldValue = pendingSuggestions[fieldName].oldValue;
            const wasEdited = previewEditedFields.has(fieldName);

            // Write value into the real form
            field.value = previewValue;
            delete field.dataset.aiNotFound;

            if (wasEdited && previewValue === pendingSuggestions[fieldName].newValue && acceptedPreviewState[fieldName] && acceptedPreviewState[fieldName].source === 'user') {
                // Case B-revert: user reverted back to the AI-suggested value
                caseA.push(label);
                field.classList.add('ai-filled');
                field.classList.remove('user-edited');
                field.dataset.overwriteSource = 'ai';
                field.dataset.aiSuggestedValue = pendingSuggestions[fieldName].newValue;
                field.dataset.revertedToAi = 'true';
                field.dataset.previousUserValue = acceptedPreviewState[fieldName].value;
            } else if (wasEdited) {
                // Case B: AI suggested, user edited
                caseB.push(label);
                field.classList.add('user-edited');
                field.classList.remove('ai-filled');
                field.dataset.overwriteSource = 'ai';
                field.dataset.aiSuggestedValue = pendingSuggestions[fieldName].newValue;
            } else {
                // Case A: AI suggested, accepted unchanged
                caseA.push(label);
                field.classList.add('ai-filled');
                field.classList.remove('user-edited');
                field.dataset.overwriteSource = 'ai';
                field.dataset.aiSuggestedValue = pendingSuggestions[fieldName].newValue;
            }

            // Set overwrite metadata
            field.dataset.previousValue = oldValue;
            field.dataset.overwrittenAt = new Date().toISOString();

            // Update unified changes map (renewals only)
            if (parseInt(form.dataset.leaseVersion) > 1) {
                const existingChange = unifiedChangesMap[fieldName];
                if (existingChange) {
                    existingChange.newValue = previewValue;
                    existingChange.source = wasEdited ? 'user' : 'ai';
                } else {
                    unifiedChangesMap[fieldName] = {
                        field: fieldName,
                        label: label,
                        oldValue: oldValue,
                        newValue: previewValue,
                        changeType: oldValue ? 'changed' : 'added',
                        source: wasEdited ? 'user' : 'ai'
                    };
                }
            }
        }
    });

    // Re-render unified changes (renewals only)
    if (parseInt(form.dataset.leaseVersion) > 1) {
        const unifiedContainer = form.parentElement.querySelector('#unifiedChanges');
        renderUnifiedChanges(unifiedChangesMap, unifiedContainer);
    }

    // Render inline explanations under each field
    LEASE_FIELDS.forEach(fieldName => {
        const field = form.querySelector('[name="' + fieldName + '"]');
        if (field) renderFieldExplanation(field);
    });

    // Detailed AI summary intentionally disabled in favor of inline field explanations
    // The Case A/B/C/D summary logic is preserved below for possible future use.
    //
    // let summaryHtml = '';
    //
    // if (caseA.length > 0) {
    //     summaryHtml += '<div class="ai-update-summary"><strong>Filled by AI:</strong>';
    //     summaryHtml += '<ul class="ai-update-list">';
    //     caseA.forEach(l => { summaryHtml += '<li>' + l + '</li>'; });
    //     summaryHtml += '</ul></div>';
    // }
    //
    // if (caseB.length > 0) {
    //     summaryHtml += '<div class="ai-update-summary"><strong>AI suggested a value, which was modified by the user:</strong>';
    //     summaryHtml += '<ul class="ai-update-list">';
    //     caseB.forEach(l => { summaryHtml += '<li>' + l + '</li>'; });
    //     summaryHtml += '</ul></div>';
    // }
    //
    // if (caseC.length > 0) {
    //     summaryHtml += '<div class="ai-update-summary"><strong>AI did not find a value; entered manually by the user:</strong>';
    //     summaryHtml += '<ul class="ai-update-list">';
    //     caseC.forEach(l => { summaryHtml += '<li>' + l + '</li>'; });
    //     summaryHtml += '</ul></div>';
    // }
    //
    // if (caseD.length > 0) {
    //     const reason = aiNotFilledReason || 'Not found in the document';
    //     summaryHtml += '<div class="ai-notfilled-summary"><strong>Not filled:</strong>';
    //     summaryHtml += '<ul class="ai-notfilled-list">';
    //     caseD.forEach(l => { summaryHtml += '<li>' + l + '<span class="ai-notfilled-reason"> \u2014 ' + reason + '</span></li>'; });
    //     summaryHtml += '</ul></div>';
    // }
    //
    // if (summaryHtml === '') {
    //     summaryHtml = 'No changes were applied.';
    // }

    const messageDiv = form.querySelector('.ai-message');
    messageDiv.className = 'ai-message success visible';
    messageDiv.textContent = 'Changes applied. See notes under each field.';

    // Mark AI as applied and disable the button
    aiHasBeenApplied = true;
    hasUnsavedChanges = true;
    const aiButton = form.querySelector('.btn-ai');
    if (aiButton) {
        aiButton.disabled = true;
        aiButton.textContent = 'AI Autofill (0 runs remaining)';
    }

    // Snapshot accepted state for reopening preview later
    acceptedPreviewState = {};
    LEASE_FIELDS.forEach(fieldName => {
        const field = form.querySelector('[name="' + fieldName + '"]');
        if (field) {
            acceptedPreviewState[fieldName] = {
                value: field.value,
                label: FIELD_LABELS[fieldName] || fieldName,
                source: field.classList.contains('ai-filled') ? 'ai'
                      : field.classList.contains('user-edited') ? 'user'
                      : 'none',
                aiValue: field.dataset.aiSuggestedValue || null
            };
        }
    });

    // Show "Return to AI Preview" button
    const returnBtn = form.querySelector('#btnReturnPreview');
    if (returnBtn) returnBtn.style.display = '';

    // Close the modal (keep aiPreviewSourceForm for reopenAiPreview)
    document.getElementById('aiPreviewModal').classList.remove('visible');
    previewEditedFields = new Set();
}

function reopenAiPreview() {
    if (!aiPreviewSourceForm || Object.keys(acceptedPreviewState).length === 0) return;

    previewEditedFields = new Set();

    const container = document.getElementById('aiPreviewFields');
    container.innerHTML = '';

    LEASE_FIELDS.forEach(fieldName => {
        const state = acceptedPreviewState[fieldName];
        if (!state) return;

        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'ai-preview-field';

        const label = document.createElement('div');
        label.className = 'ai-preview-label';
        label.textContent = state.label;
        fieldDiv.appendChild(label);

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'ai-preview-input';
        input.dataset.fieldName = fieldName;
        input.value = state.value;

        if (state.source === 'user') {
            input.classList.add('preview-edited');
            previewEditedFields.add(fieldName);
        }

        if (state.source === 'none') {
            input.dataset.notFound = 'true';
            input.classList.add('preview-notfound');
            input.placeholder = 'Enter manually if known';
        }

        input.addEventListener('input', function() {
            previewEditedFields.add(fieldName);
            input.classList.add('preview-edited');
        });

        fieldDiv.appendChild(input);

        if (state.source === 'user' && state.aiValue) {
            const hint = document.createElement('div');
            hint.className = 'ai-preview-hint';
            hint.textContent = 'AI originally suggested \'' + state.aiValue + '\'. You changed this to \'' + state.value + '\'. Because you edited this previously, the value has not reverted to the AI suggestion.';
            fieldDiv.appendChild(hint);
        }

        container.appendChild(fieldDiv);
    });

    document.getElementById('aiPreviewModal').classList.add('visible');
}

function renderFieldExplanation(field) {
    var existing = field.parentElement.querySelector('.field-explanation');
    if (existing) existing.remove();

    if (field.name === 'lease_nickname') return;

    var text = '';
    if (field.dataset.revertedToAi === 'true') {
        var aiVal = field.dataset.aiSuggestedValue || '';
        var prevUser = field.dataset.previousUserValue || '';
        text = 'AI originally suggested \'' + aiVal + '\'. You had previously changed this to \'' + prevUser + '\'. You have now reverted to the AI-suggested value.';
    } else if (field.classList.contains('ai-filled')) {
        text = 'Suggested by AI';
    } else if (field.classList.contains('user-edited') && field.dataset.overwriteSource === 'ai') {
        var aiVal = field.dataset.aiSuggestedValue || '';
        text = 'AI suggested \'' + aiVal + '\', changed by you';
    } else if (field.classList.contains('user-edited') && field.dataset.overwriteSource === 'user') {
        text = 'Entered by you';
    } else if (field.dataset.aiNotFound === 'true') {
        var reason = aiNotFilledReason || 'Not found in the document';
        text = 'AI did not find a value \u2014 ' + reason;
    }

    if (text) {
        var div = document.createElement('div');
        div.className = 'field-explanation';
        div.textContent = text;
        field.parentElement.appendChild(div);
    }
}

// Initialize edit tracking for a form
function initEditTracking(form) {
    if (!form || manuallyEditedFields.has(form)) return;

    const editedSet = new Set();
    manuallyEditedFields.set(form, editedSet);

    LEASE_FIELDS.forEach(fieldName => {
        const field = form.querySelector(`[name="${fieldName}"]`);
        if (field) {
            field.addEventListener('input', () => {
                editedSet.add(fieldName);
                field.classList.add('user-edited');
                field.classList.remove('ai-filled');
            });
            field.addEventListener('change', () => {
                editedSet.add(fieldName);
                field.classList.add('user-edited');
                field.classList.remove('ai-filled');
            });
        }
    });
}

// Check if a field was manually edited
function wasManuallyEdited(form, fieldName) {
    const editedSet = manuallyEditedFields.get(form);
    return editedSet ? editedSet.has(fieldName) : false;
}

// Get current field value
function getFieldValue(form, fieldName) {
    const field = form.querySelector(`[name="${fieldName}"]`);
    return field ? field.value : '';
}

// Initialize tracking on page load
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.confirm-form form').forEach(initEditTracking);
});

function aiPrefill(button) {
    const form = button.closest('form');
    const messageDiv = form.querySelector('.ai-message');

    // Show global loading immediately
    setLoading(true, 'Running AI analysis\u2026');

    // Capture ALL prior values BEFORE AI updates (not just manually edited)
    // This ensures renewal leases with pre-filled values are handled correctly
    const priorValues = {};
    LEASE_FIELDS.forEach(fieldName => {
        priorValues[fieldName] = getFieldValue(form, fieldName);
    });

    // Show loading state
    button.disabled = true;
    const originalText = button.textContent;
    button.textContent = ' Analyzing...';
    messageDiv.className = 'ai-message loading visible';
    messageDiv.textContent = 'AI is analyzing your lease document...';

    // Get lease_id from the form (hidden input)
    const leaseIdInput = form.querySelector('[name="lease_id"]');
    const leaseId = leaseIdInput ? leaseIdInput.value : null;

    if (!leaseId) {
        messageDiv.className = 'ai-message error visible';
        messageDiv.textContent = 'Error: No lease ID found. Please save the lease first.';
        button.disabled = false;
        button.textContent = originalText;
        setLoading(false);
        return;
    }

    fetch('/ai_prefill', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ lease_id: leaseId })
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.textContent = originalText;

        if (data.success) {
            const d = data.data;
            const updates = [];        // Fields where AI has a different suggestion
            const overwrites = [];     // Fields that had prior values and AI suggests different
            const unchanged = [];      // Fields where AI value matched existing
            pendingSuggestions = {}; // Reset pending suggestions for this AI run

            // Initialize unified changes from version changes (for renewal leases only)
            const leaseVersion = parseInt(form.dataset.leaseVersion) || 1;
            if (leaseVersion > 1) {
                unifiedChangesMap = initUnifiedChanges(form);
            } else {
                unifiedChangesMap = {};
            }

            // Helper to safely extract value from AI response field
            // Returns null if value is missing, null, undefined, or empty string
            const getValue = (field) => {
                if (field && typeof field === 'object' && field.value !== null && field.value !== undefined) {
                    const strVal = String(field.value).trim();
                    return strVal === '' ? null : strVal;
                }
                return null;
            };

            // Helper to normalize values for comparison (handles type coercion)
            const normalizeValue = (val) => {
                if (val === null || val === undefined) return '';
                return String(val).trim();
            };

            // Store AI suggestion WITHOUT applying to form
            const updateField = (fieldName, newValue) => {
                // Skip if AI returned null/undefined
                if (newValue === null || newValue === undefined) return false;

                const field = form.querySelector(`[name="${fieldName}"]`);
                if (!field) return false;

                const oldValue = priorValues[fieldName];
                const normalizedOld = normalizeValue(oldValue);
                const normalizedNew = normalizeValue(newValue);

                // If values are identical, skip but note it
                if (normalizedOld === normalizedNew) {
                    unchanged.push({
                        fieldName: fieldName,
                        label: FIELD_LABELS[fieldName] || fieldName
                    });
                    return false;
                }

                // Store as pending suggestion (DO NOT write to form)
                pendingSuggestions[fieldName] = {
                    label: FIELD_LABELS[fieldName] || fieldName,
                    oldValue: oldValue,
                    newValue: newValue
                };

                // Track this as an update for messaging
                updates.push({
                    fieldName: fieldName,
                    label: FIELD_LABELS[fieldName] || fieldName,
                    oldValue: oldValue,
                    newValue: newValue
                });

                // If field had a prior non-empty value, track as overwrite
                if (normalizedOld !== '') {
                    overwrites.push({
                        fieldName: fieldName,
                        label: FIELD_LABELS[fieldName] || fieldName,
                        oldValue: oldValue,
                        newValue: newValue
                    });
                }

                return true;
            };

            // Update ALL fields - AI always applies regardless of prior state
            // lease_nickname has direct value (not nested)
            if (d.lease_nickname) {
                updateField('lease_nickname', d.lease_nickname);
                const aiHint = form.querySelector('#nickname-ai-hint');
                if (aiHint) aiHint.classList.add('visible');
            }

            // Other fields have nested structure {value, page, evidence}
            updateField('lessor_name', getValue(d.lessor_name));
            updateField('lessee_name', getValue(d.lessee_name));
            updateField('lease_start_date', getValue(d.start_date));
            updateField('lease_end_date', getValue(d.end_date));
            updateField('monthly_rent', getValue(d.monthly_rent));
            updateField('security_deposit', getValue(d.security_deposit));
            updateField('rent_due_day', getValue(d.rent_due_day));
            updateField('lock_in_months', getValue(d.lock_in_duration_months));
            updateField('rent_escalation_percent', getValue(d.rent_escalation_percent));

            // Compute "not filled" fields and reason (needed by preview modal and apply logic)
            aiNotFilledFields = [];
            LEASE_FIELDS.forEach(fieldName => {
                if (fieldName === 'lease_nickname') return;
                const hadValueBefore = priorValues[fieldName] && priorValues[fieldName].trim() !== '';
                const aiSuggested = pendingSuggestions.hasOwnProperty(fieldName);
                if (!hadValueBefore && !aiSuggested) {
                    aiNotFilledFields.push({ fieldName: fieldName, label: FIELD_LABELS[fieldName] || fieldName });
                }
            });

            if (aiNotFilledFields.length > 0 && updates.length > 0) {
                const hasUncertainty = d.confidence_notes && String(d.confidence_notes).trim() !== '' && updates.length > 0;
                aiNotFilledReason = hasUncertainty
                    ? 'AI could not determine this confidently'
                    : 'Not found in the document';
            } else {
                aiNotFilledReason = '';
            }

            // Show a single neutral status message (detailed summary comes after Apply)
            if (updates.length === 0) {
                messageDiv.className = 'ai-message success visible';
                messageDiv.innerHTML = 'AI analysis complete. No new values were found in the document, or all fields already match.';
            } else {
                messageDiv.className = 'ai-message success visible';
                messageDiv.innerHTML = 'AI analysis complete. Review suggestions before applying.';
            }

            // Open preview modal if there are pending suggestions
            openAiPreviewModal(form);
        } else if (data.error_code === 'no_document') {
            // Legacy lease with no PDF  show informational modal instead of error
            messageDiv.className = 'ai-message';
            messageDiv.textContent = '';
            var reuploadLink = document.getElementById('reuploadLeaseLink');
            if (reuploadLink) reuploadLink.href = '/?new=true&renew_from=' + encodeURIComponent(leaseId);
            document.getElementById('missingDocumentModal').classList.add('visible');
        } else {
            messageDiv.className = 'ai-message error visible';
            messageDiv.textContent = data.error || 'AI extraction failed. Please fill in the fields manually.';
        }
    })
    .catch(error => {
        button.disabled = false;
        button.textContent = originalText;
        messageDiv.className = 'ai-message error visible';
        messageDiv.textContent = 'Unable to connect to AI service. Please fill in the fields manually.';
    })
    .finally(() => {
        setLoading(false);
    });
}

// Toggle version changes visibility in View Mode
function toggleFlagWarning(select) {
    var warning = select.closest('form').querySelector('.flag-warning');
    if (warning) warning.style.display = select.value === 'flagged' ? 'block' : 'none';
}

// Initialize unified changes display in Edit Mode
function initUnifiedChanges(form) {
    const versionChangesJson = form.dataset.versionChanges;
    const leaseVersion = parseInt(form.dataset.leaseVersion) || 1;

    // Only for renewal leases (version > 1)
    if (leaseVersion <= 1 || !versionChangesJson) return {};

    try {
        const versionChanges = JSON.parse(versionChangesJson);
        const changesMap = {};

        // Initialize with version changes
        versionChanges.forEach(change => {
            changesMap[change.field] = {
                field: change.field,
                label: change.label,
                oldValue: change.old_value,
                newValue: change.new_value,
                changeType: change.change_type,
                source: 'version' // Tagged as version change
            };
        });

        return changesMap;
    } catch (e) {
        console.error('Failed to parse version changes:', e);
        return {};
    }
}

// Format monetary values with commas for display
const MONEY_FIELDS = ['monthly_rent', 'security_deposit'];
function formatMoney(value) {
    if (value === null || value === undefined || value === '' || value === '(empty)') return value;
    const num = Number(value);
    if (isNaN(num)) return value;
    return Number.isInteger(num) ? num.toLocaleString() : num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

// Render unified changes display
function renderUnifiedChanges(changesMap, container) {
    if (!container) return;

    const changes = Object.values(changesMap);
    if (changes.length === 0) {
        container.style.display = 'none';
        container.innerHTML = '';
        return;
    }

    container.style.display = 'block';

    let html = '<div class="unified-changes">';
    html += '<h4>Previous values replaced</h4>';
    html += '<ul class="changes-list">';

    changes.forEach(c => {
        const isMoney = MONEY_FIELDS.includes(c.field);
        const oldDisplay = isMoney ? formatMoney(c.oldValue || '(empty)') : (c.oldValue || '(empty)');
        const newDisplay = isMoney ? formatMoney(c.newValue || '(empty)') : (c.newValue || '(empty)');
        const sourceTag = c.source === 'ai' ? 'Updated by AI' : 'Changed from previous version';
        const sourceClass = c.source === 'ai' ? 'source-ai' : 'source-version';

        html += `<li>`;
        html += `<span class="field-name">${escapeHtml(c.label)}:</span> `;
        html += `<span class="old-value">${escapeHtml(String(oldDisplay))}</span>`;
        html += ` <span class="arrow"></span> `;
        html += `<span class="new-value">${escapeHtml(String(newDisplay))}</span>`;
        html += ` <span class="source-tag ${sourceClass}">${sourceTag}</span>`;
        html += `</li>`;
    });

    html += '</ul></div>';
    container.innerHTML = html;
}

// Global map for unified changes (keyed by field name)
let unifiedChangesMap = {};
</script>
</div>

<!-- DELETE CONFIRMATION MODAL -->
<div class="delete-modal-overlay" id="deleteModal">
    <div class="delete-modal">
        <div class="delete-modal-header">
            <h3 id="deleteModalTitle">Confirm Deletion</h3>
        </div>
        <div class="delete-modal-body">
            <div class="delete-modal-warning">
                <p>
                    <strong>This action cannot be undone.</strong>
                    Once deleted, all data associated with this lease will be permanently removed.
                </p>
            </div>
            <div class="delete-modal-info" id="deleteModalInfo">
                <!-- Filled by JavaScript -->
            </div>
            <div class="delete-modal-confirm">
                <label id="deleteModalLabel">
                    Type <code id="deleteConfirmText">DELETE</code> to confirm:
                </label>
                <input type="text" id="deleteConfirmInput" autocomplete="off" spellcheck="false"
                       onkeydown="if(event.key==='Enter'){event.preventDefault();var btn=document.getElementById('deleteModalSubmit');if(!btn.disabled)document.getElementById('deleteModalForm').requestSubmit();}">
            </div>
        </div>
        <div class="delete-modal-footer">
            <button type="button" class="delete-modal-cancel" onclick="closeDeleteModal()">Cancel</button>
            <form id="deleteModalForm" action="/reset" method="post" style="margin: 0;">
                <input type="hidden" name="lease_id" id="deleteLeaseId">
                <input type="hidden" name="confirm_text" id="deleteConfirmHidden">
                <input type="hidden" name="expected_text" id="deleteExpectedHidden">
                <input type="hidden" name="delete_group" id="deleteGroupHidden" value="false">
                <button type="submit" class="delete-modal-submit" id="deleteModalSubmit" disabled>
                    Delete Permanently
                </button>
            </form>
        </div>
    </div>
</div>

<!-- MISSING DOCUMENT MODAL (legacy lease) -->
<div class="missing-doc-overlay" id="missingDocumentModal">
    <div class="missing-doc-modal">
        <div class="missing-doc-header">
            <h3>Lease Document Needed</h3>
        </div>
        <div class="missing-doc-body">
            <p>This lease was added earlier, and the original document isn't available in the app anymore. Because of this, AI can't review the lease automatically.</p>
            <p>If you upload the lease document again, the app will save it properly and AI features will work as expected.</p>
        </div>
        <div class="missing-doc-footer">
            <button type="button" class="missing-doc-close" onclick="closeMissingDocumentModal()">Close</button>
            <a id="reuploadLeaseLink" href="#" class="missing-doc-action">Upload Lease Document</a>
        </div>
    </div>
</div>

<!-- AI Suggestions Preview Modal -->
<div class="ai-preview-overlay" id="aiPreviewModal">
    <div class="ai-preview-modal">
        <div class="ai-preview-header">
            <h3>AI Suggestions  Review Before Applying</h3>
        </div>
        <div class="ai-preview-body">
            <p class="ai-preview-note">Review the AI suggestions below. Edit any field, or clear it to skip. Click "Apply Changes" when ready.</p>
            <div id="aiPreviewFields"></div>
        </div>
        <div class="ai-preview-footer">
            <button type="button" class="ai-preview-cancel" onclick="closeAiPreviewModal()">Cancel</button>
            <a id="aiPreviewPdfLink" href="#" target="_blank" class="ai-preview-pdf">View Lease Document (PDF)</a>
            <button type="button" class="ai-preview-apply" onclick="applyAiPreview()">Apply Changes</button>
        </div>
    </div>
</div>

<script>
function closeMissingDocumentModal() {
    document.getElementById('missingDocumentModal').classList.remove('visible');
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('form').forEach(form => {
        // Only attach to forms that upload files
        const fileInput = form.querySelector('input[type="file"]');
        if (!fileInput) return;

        form.addEventListener('submit', function () {
            setLoading(true, 'Uploading and processing lease document\u2026 this may take up to a minute.');
            // Force browser to repaint so overlay is visible before navigation begins
            document.getElementById('globalLoadingOverlay').offsetHeight;
        });
    });
});
</script>

<script>
// Delete modal state
let deleteModalExpectedText = 'DELETE';

function openDeleteModal(leaseId, leaseName, isGroupDelete) {
    const modal = document.getElementById('deleteModal');
    const titleEl = document.getElementById('deleteModalTitle');
    const infoEl = document.getElementById('deleteModalInfo');
    const labelEl = document.getElementById('deleteModalLabel');
    const confirmTextEl = document.getElementById('deleteConfirmText');
    const confirmInput = document.getElementById('deleteConfirmInput');
    const leaseIdInput = document.getElementById('deleteLeaseId');
    const expectedInput = document.getElementById('deleteExpectedHidden');
    const submitBtn = document.getElementById('deleteModalSubmit');

    // Reset state
    confirmInput.value = '';
    submitBtn.disabled = true;
    leaseIdInput.value = leaseId;
    document.getElementById('deleteGroupHidden').value = isGroupDelete ? 'true' : 'false';

    if (isGroupDelete) {
        // For entire lease group deletion, require typing DELETE
        titleEl.textContent = 'Delete Entire Lease';
        infoEl.innerHTML = 'This will permanently delete <span class="lease-name">' + escapeHtml(leaseName) + '</span> and all of its versions (including renewals). This action cannot be undone.<br><br>If you want to delete an individual lease version, please do so from inside the lease itself.';
        deleteModalExpectedText = 'DELETE';
        confirmTextEl.textContent = 'DELETE';
        labelEl.innerHTML = 'Type <code>DELETE</code> to confirm:';
    } else {
        // For single lease/version deletion
        titleEl.textContent = 'Delete Lease';
        infoEl.innerHTML = 'You are about to delete <span class="lease-name">' + escapeHtml(leaseName || 'this lease') + '</span> permanently.';
        deleteModalExpectedText = 'DELETE';
        confirmTextEl.textContent = 'DELETE';
        labelEl.innerHTML = 'Type <code>DELETE</code> to confirm:';
    }

    expectedInput.value = deleteModalExpectedText;
    modal.classList.add('visible');
    confirmInput.focus();

    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('visible');
    document.body.style.overflow = '';
}

function openVersionDeleteModal(versionId, versionNumber, isCurrent, totalVersions) {
    const modal = document.getElementById('deleteModal');
    const titleEl = document.getElementById('deleteModalTitle');
    const infoEl = document.getElementById('deleteModalInfo');
    const labelEl = document.getElementById('deleteModalLabel');
    const confirmTextEl = document.getElementById('deleteConfirmText');
    const confirmInput = document.getElementById('deleteConfirmInput');
    const leaseIdInput = document.getElementById('deleteLeaseId');
    const expectedInput = document.getElementById('deleteExpectedHidden');
    const submitBtn = document.getElementById('deleteModalSubmit');

    // Reset state
    confirmInput.value = '';
    submitBtn.disabled = true;
    leaseIdInput.value = versionId;

    // Set title and info based on context
    titleEl.textContent = 'Delete Lease Version';

    let infoHtml = 'You are about to delete <span class="lease-name">Version ' + versionNumber + '</span>.';

    if (totalVersions <= 1) {
        // Last version - will delete entire lease
        infoHtml += '<br><br><strong>Warning:</strong> This is the only version. Deleting it will remove the entire lease.';
    } else if (isCurrent) {
        // Current version - will revert to previous
        infoHtml += '<br><br><strong>Note:</strong> This is the current version. The lease will revert to the previous version.';
    }

    infoEl.innerHTML = infoHtml;

    // Always require "DELETE" for version deletion
    deleteModalExpectedText = 'DELETE';
    confirmTextEl.textContent = 'DELETE';
    labelEl.innerHTML = 'Type <code>DELETE</code> to confirm:';
    expectedInput.value = 'DELETE';

    modal.classList.add('visible');
    confirmInput.focus();

    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Validate confirmation input
document.getElementById('deleteConfirmInput').addEventListener('input', function(e) {
    const submitBtn = document.getElementById('deleteModalSubmit');
    const hiddenInput = document.getElementById('deleteConfirmHidden');
    const inputValue = e.target.value;

    hiddenInput.value = inputValue;

    if (inputValue.toUpperCase() === deleteModalExpectedText.toUpperCase()) {
        submitBtn.disabled = false;
    } else {
        submitBtn.disabled = true;
    }
});

// Close modal on overlay click
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDeleteModal();
    }
});

// Prevent form submission if button is disabled
document.getElementById('deleteModalForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('deleteModalSubmit');
    if (submitBtn.disabled) {
        e.preventDefault();
        return false;
    }
    // Additional client-side validation
    const confirmInput = document.getElementById('deleteConfirmInput').value;
    if (confirmInput.toUpperCase() !== deleteModalExpectedText.toUpperCase()) {
        e.preventDefault();
        alert('Confirmation text does not match. Deletion aborted.');
        return false;
    }
});
</script>

<!-- EXTRACTED TEXT MODAL -->
<div class="text-modal-overlay" id="textModal">
    <div class="text-modal">
        <div class="text-modal-header">
            <h3>Extracted Text</h3>
            <button type="button" class="text-modal-close" onclick="closeTextModal()">Close</button>
        </div>
        <div class="text-modal-body">
            <textarea readonly>{{ lease_data.source_document.extracted_text if lease_data and lease_data.source_document and lease_data.source_document.extracted_text else 'No extracted text available.' }}</textarea>
        </div>
    </div>
</div>

<!-- PDF VIEWER MODAL -->
<div class="text-modal-overlay" id="pdfModal">
    <div class="text-modal pdf-modal">
        <div class="text-modal-header">
            <h3>Original Lease PDF</h3>
            <button type="button" class="text-modal-close" onclick="closePdfModal()">Close</button>
        </div>
        <div class="text-modal-body pdf-modal-body">
            <div id="pdfViewer"></div>
        </div>
    </div>
</div>

<!-- CHANGES FROM PREVIOUS LEASE MODAL -->
{% if version_changes and version_changes|length > 0 %}
<div class="text-modal-overlay" id="changesModal">
    <div class="text-modal">
        <div class="text-modal-header">
            <h3>Changes from Previous Lease</h3>
            <div style="display: flex; gap: 8px;">
                <button type="button" onclick="window.print()" style="background: #e0f2fe; border: 1px solid #7dd3fc; border-radius: 6px; padding: 8px 16px; font-size: 14px; font-weight: 500; color: #0369a1; cursor: pointer;">Print</button>
                <button type="button" class="text-modal-close" onclick="closeChangesModal()">Close</button>
            </div>
        </div>
        <div class="text-modal-body">
            {% for change in version_changes %}
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f3f4f6;">
                <span style="font-weight: 500; color: #374151;">{{ change.label }}</span>
                <span>
                    {% if change.change_type == 'unchanged' %}
                        {{ change.new_value | format_money }}
                        <span style="color: #9ca3af; font-size: 0.85em; margin-left: 6px;">(No change from previous lease)</span>
                    {% elif change.change_type == 'added' %}
                        <span class="change-added">{{ change.new_value | format_money }}</span>
                        <span class="change-note">(new)</span>
                    {% elif change.change_type == 'removed' %}
                        <span class="change-removed">{{ (change.old_value or '') | format_money }}</span>
                        <span class="change-note">(removed)</span>
                    {% else %}
                        <span class="change-old">{{ (change.old_value or '') | format_money }}</span>
                        <span class="change-arrow"></span>
                        <span class="change-new">{{ (change.new_value or '') | format_money }}</span>
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- PER-MONTH SUBMISSIONS MODAL -->
<div class="text-modal-overlay" id="submissionsModal">
    <div class="text-modal">
        <div class="text-modal-header">
            <h3 id="submissionsModalTitle">Submissions</h3>
            <div style="display: flex; gap: 8px;">
                <button type="button" id="submissionsBackBtn" style="display: none;" class="text-modal-close" onclick="backToMonthView()">Back</button>
                <button type="button" id="submissionsPrintBtn" style="display: none;" class="text-modal-close" onclick="window.print()">Print</button>
                <button type="button" id="submissionsHistoryBtn" class="text-modal-close" onclick="viewFullHistory()">View full history</button>
                <button type="button" class="text-modal-close" onclick="closeSubmissionsModal()">Close</button>
            </div>
        </div>
        <div class="text-modal-body" id="submissionsModalBody">
        </div>
    </div>
</div>

<script>
function openTextModal() {
    const modal = document.getElementById('textModal');
    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function closeTextModal() {
    const modal = document.getElementById('textModal');
    modal.classList.remove('visible');
    document.body.style.overflow = '';
}

// Close text modal when clicking outside
document.getElementById('textModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTextModal();
    }
});

// Close text modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const textModal = document.getElementById('textModal');
        if (textModal && textModal.classList.contains('visible')) {
            closeTextModal();
        }
        const changesModal = document.getElementById('changesModal');
        if (changesModal && changesModal.classList.contains('visible')) {
            closeChangesModal();
        }
        const submissionsModal = document.getElementById('submissionsModal');
        if (submissionsModal && submissionsModal.classList.contains('visible')) {
            closeSubmissionsModal();
        }
    }
});

// CHANGES MODAL FUNCTIONS
function openChangesModal() {
    const modal = document.getElementById('changesModal');
    if (modal) {
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden';
    }
}

function closeChangesModal() {
    const modal = document.getElementById('changesModal');
    if (modal) {
        modal.classList.remove('visible');
        document.body.style.overflow = '';
    }
}

var changesModalEl = document.getElementById('changesModal');
if (changesModalEl) {
    changesModalEl.addEventListener('click', function(e) {
        if (e.target === this) closeChangesModal();
    });
}

// SUBMISSIONS MODAL FUNCTIONS
var submissionsState = { month: null, year: null, monthName: null, viewMode: 'month', origin: 'month' };

var _llMonthData = {{ monthly_summary | default([], true) | tojson }};

function _fmtDate(dateStr) {
    if (!dateStr) return '';
    try {
        var dt = new Date(dateStr);
        if (isNaN(dt.getTime())) return dateStr;
        var mo = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        return dt.getDate() + ' ' + mo[dt.getMonth()] + ' ' + dt.getFullYear();
    } catch(e) { return dateStr; }
}

function _buildLandlordOverview(month, year) {
    var ms = null;
    for (var i = 0; i < _llMonthData.length; i++) {
        if (_llMonthData[i].month === month && _llMonthData[i].year === year) { ms = _llMonthData[i]; break; }
    }
    if (!ms || ms.expected_categories === null) return '';
    var CL = {rent:'Rent', maintenance:'Maintenance', utilities:'Utilities'};
    var CO = ['rent','maintenance','utilities'];
    var cd = ms.category_details || {};
    var cdKeys = Object.keys(cd);
    // All acknowledged + complete  green success
    if (ms.is_complete && cdKeys.length > 0) {
        var allAck = true;
        for (var k = 0; k < cdKeys.length; k++) { if (cd[cdKeys[k]].state !== 'acknowledged') { allAck = false; break; } }
        if (allAck) {
            return '<div class="modal-overview" style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px;padding:10px 14px;margin-bottom:12px;font-size:0.9em;">' +
                '<span style="color:#16a34a;font-weight:600;">\u2705 All expected payments submitted and acknowledged</span></div>';
        }
    }
    var lines = [];
    // Block 1: Missing
    var miss = ms.missing_categories || [];
    for (var i = 0; i < CO.length; i++) {
        if (miss.indexOf(CO[i]) !== -1) lines.push('<div style="line-height:1.6;color:#9ca3af;">\u2b1c ' + CL[CO[i]] + ' \u2014 not submitted</div>');
    }
    // Block 2: Submitted but unresolved
    for (var i = 0; i < CO.length; i++) {
        var cat = CO[i];
        if (!cd[cat] || cd[cat].state === 'acknowledged') continue;
        var s = cd[cat].state, d = cd[cat].date ? ' on ' + _fmtDate(cd[cat].date) : '';
        if (s === 'tenant_replied') {
            lines.push('<div style="line-height:1.6;"><span style="color:#1e40af;">\uD83D\uDCAC</span> <span style="color:#1e40af;font-weight:600;">' + CL[cat] + ' \u2014 tenant responded' + d + ', pending your review</span></div>');
        } else if (s === 'flagged') {
            if (cd[cat].flag_date && cd[cat].flag_date === cd[cat].date) {
                lines.push('<div style="line-height:1.6;"><span style="color:#92400e;">\u26A0\uFE0F</span> <span style="color:#92400e;font-weight:600;">' + CL[cat] + ' \u2014 flag raised by you' + d + ', awaiting tenant response</span></div>');
            } else {
                lines.push('<div style="line-height:1.6;"><span style="color:#92400e;">\u26A0\uFE0F</span> <span style="color:#92400e;font-weight:600;">' + CL[cat] + ' \u2014 you responded' + d + ', awaiting tenant response</span></div>');
            }
        } else if (s === 'pending_review') {
            lines.push('<div style="line-height:1.6;"><span style="color:#1e40af;">\uD83D\uDD0D</span> <span style="color:#1e40af;font-weight:600;">' + CL[cat] + ' \u2014 tenant submitted' + d + ', pending your review</span></div>');
        }
    }
    if (lines.length === 0) return '';
    return '<div class="modal-overview" style="background:#fafafa;border:1px solid #e5e7eb;border-radius:6px;padding:10px 14px;margin-bottom:12px;font-size:0.9em;">' +
        '<div style="font-weight:600;margin-bottom:6px;color:#374151;">Payment Overview</div>' + lines.join('') + '</div>';
}

function _injectLandlordOverview(body, month, year) {
    var html = _buildLandlordOverview(month, year);
    if (html) {
        var tmp = document.createElement('div');
        tmp.innerHTML = html;
        body.insertBefore(tmp.firstChild, body.firstChild);
    }
    var disc = document.createElement('p');
    disc.className = 'modal-disclaimer';
    disc.style.cssText = 'color:#aaa;font-size:0.75em;margin:12px 0 0 0;text-align:center;';
    disc.textContent = 'Document uploads indicate that a submission was made. They do not confirm payment, accuracy, or landlord approval.';
    body.appendChild(disc);
}

function _findLLMonth(month, year) {
    for (var i = 0; i < _llMonthData.length; i++) {
        if (_llMonthData[i].month === month && _llMonthData[i].year === year) return _llMonthData[i];
    }
    return null;
}

function _injectLLPartialNotice(body, month, year) {
    if (!body.querySelector('[data-period-month]')) return;
    var ms = _findLLMonth(month, year);
    if (!ms || !ms.missing_categories || ms.missing_categories.length === 0) return;
    var p = document.createElement('p');
    p.className = 'modal-partial-notice';
    p.style.cssText = 'color:#92400e;font-size:0.82em;margin:0 0 10px 0;';
    p.textContent = 'Some expected payments for this month have not been submitted.';
    var overview = body.querySelector('.modal-overview');
    if (overview && overview.nextSibling) {
        body.insertBefore(p, overview.nextSibling);
    } else {
        var firstCard = body.querySelector('[data-period-month]');
        if (firstCard) body.insertBefore(p, firstCard);
    }
}

function openSubmissionsModal(month, year, monthName) {
    submissionsState.month = month;
    submissionsState.year = year;
    submissionsState.monthName = monthName;
    submissionsState.viewMode = 'month';
    submissionsState.origin = 'month';

    var modal = document.getElementById('submissionsModal');
    var body = document.getElementById('submissionsModalBody');
    var title = document.getElementById('submissionsModalTitle');
    var storage = document.getElementById('payment-submissions');
    if (!modal || !body) return;

    // Defensive: move any leftover cards back to storage
    while (body.firstChild) { storage.appendChild(body.firstChild); }
    var empties = storage.querySelectorAll('.modal-empty-state');
    empties.forEach(function(el) { el.remove(); });

    // Ensure review mode (not history)
    body.classList.remove('history-view');

    // Move only matching month cards
    var allCards = document.querySelectorAll('[data-period-month][data-period-year]');
    allCards.forEach(function(card) {
        if (String(card.dataset.periodMonth) === String(month) &&
            String(card.dataset.periodYear) === String(year)) {
            body.appendChild(card);
        }
    });

    // Empty state if no cards matched
    if (!body.querySelector('[data-period-month]')) {
        var p = document.createElement('p');
        p.className = 'modal-empty-state';
        p.style.cssText = 'text-align: center; color: #9ca3af; padding: 32px 0; font-size: 0.95em;';
        p.textContent = 'No submissions have been made for this month yet.';
        body.appendChild(p);
    }

    // Inject payment overview + disclaimer
    _injectLandlordOverview(body, month, year);
    _injectLLPartialNotice(body, month, year);

    // Set title and button visibility for month view
    title.textContent = 'Submissions for ' + monthName + ' ' + year;
    document.getElementById('submissionsHistoryBtn').style.display = '';
    document.getElementById('submissionsBackBtn').style.display = 'none';
    document.getElementById('submissionsPrintBtn').style.display = 'none';

    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function openFullHistoryModal() {
    submissionsState.month = null;
    submissionsState.year = null;
    submissionsState.monthName = null;
    submissionsState.viewMode = 'history';
    submissionsState.origin = 'page';

    var modal = document.getElementById('submissionsModal');
    var body = document.getElementById('submissionsModalBody');
    var title = document.getElementById('submissionsModalTitle');
    var storage = document.getElementById('payment-submissions');
    if (!modal || !body) return;

    // Defensive: move any leftover cards back to storage
    while (body.firstChild) { storage.appendChild(body.firstChild); }
    var empties = storage.querySelectorAll('.modal-empty-state');
    empties.forEach(function(el) { el.remove(); });

    // Enable history (read-only) mode
    body.classList.add('history-view');

    // Move ALL submission cards into modal
    var allCards = storage.querySelectorAll('[data-period-month][data-period-year]');
    allCards.forEach(function(card) { body.appendChild(card); });

    // Empty state if no cards exist
    if (!body.querySelector('[data-period-month]')) {
        var p = document.createElement('p');
        p.className = 'modal-empty-state';
        p.style.cssText = 'text-align: center; color: #9ca3af; padding: 32px 0; font-size: 0.95em;';
        p.textContent = 'No submissions exist for this lease yet.';
        body.appendChild(p);
    }

    // Set title and button visibility  no Back (opened from page)
    title.textContent = 'All Payment Submissions';
    document.getElementById('submissionsHistoryBtn').style.display = 'none';
    document.getElementById('submissionsBackBtn').style.display = 'none';
    document.getElementById('submissionsPrintBtn').style.display = '';

    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function viewFullHistory() {
    submissionsState.viewMode = 'history';
    var body = document.getElementById('submissionsModalBody');
    var title = document.getElementById('submissionsModalTitle');
    var storage = document.getElementById('payment-submissions');
    if (!body || !storage) return;

    // Move current cards back to storage
    while (body.firstChild) { storage.appendChild(body.firstChild); }
    var empties = storage.querySelectorAll('.modal-empty-state');
    empties.forEach(function(el) { el.remove(); });

    // Enable history (read-only) mode
    body.classList.add('history-view');

    // Move ALL submission cards into modal
    var allCards = storage.querySelectorAll('[data-period-month][data-period-year]');
    allCards.forEach(function(card) { body.appendChild(card); });

    // Empty state if no cards exist
    if (!body.querySelector('[data-period-month]')) {
        var p = document.createElement('p');
        p.className = 'modal-empty-state';
        p.style.cssText = 'text-align: center; color: #9ca3af; padding: 32px 0; font-size: 0.95em;';
        p.textContent = 'No submissions exist for this lease yet.';
        body.appendChild(p);
    }

    // Set title and button visibility  Back shows with month context
    title.textContent = 'All Payment Submissions';
    document.getElementById('submissionsHistoryBtn').style.display = 'none';
    var backBtn = document.getElementById('submissionsBackBtn');
    backBtn.textContent = 'Back to ' + submissionsState.monthName + ' ' + submissionsState.year;
    backBtn.style.display = '';
    document.getElementById('submissionsPrintBtn').style.display = '';
}

function backToMonthView() {
    submissionsState.viewMode = 'month';
    var body = document.getElementById('submissionsModalBody');
    var title = document.getElementById('submissionsModalTitle');
    var storage = document.getElementById('payment-submissions');
    if (!body || !storage) return;

    // Move all cards back to storage
    while (body.firstChild) { storage.appendChild(body.firstChild); }
    var empties = storage.querySelectorAll('.modal-empty-state');
    empties.forEach(function(el) { el.remove(); });

    // Disable history mode (restore interactivity)
    body.classList.remove('history-view');

    // Move only the original month's cards back in
    var allCards = storage.querySelectorAll('[data-period-month][data-period-year]');
    allCards.forEach(function(card) {
        if (String(card.dataset.periodMonth) === String(submissionsState.month) &&
            String(card.dataset.periodYear) === String(submissionsState.year)) {
            body.appendChild(card);
        }
    });

    // Empty state if no cards matched
    if (!body.querySelector('[data-period-month]')) {
        var p = document.createElement('p');
        p.className = 'modal-empty-state';
        p.style.cssText = 'text-align: center; color: #9ca3af; padding: 32px 0; font-size: 0.95em;';
        p.textContent = 'No submissions have been made for this month yet.';
        body.appendChild(p);
    }

    // Inject payment overview + disclaimer
    _injectLandlordOverview(body, submissionsState.month, submissionsState.year);
    _injectLLPartialNotice(body, submissionsState.month, submissionsState.year);

    // Restore title and button visibility for month view
    title.textContent = 'Submissions for ' + submissionsState.monthName + ' ' + submissionsState.year;
    document.getElementById('submissionsHistoryBtn').style.display = '';
    document.getElementById('submissionsBackBtn').style.display = 'none';
    document.getElementById('submissionsPrintBtn').style.display = 'none';
}

function closeSubmissionsModal() {
    var modal = document.getElementById('submissionsModal');
    var body = document.getElementById('submissionsModalBody');
    var storage = document.getElementById('payment-submissions');
    if (!modal || !body || !storage) return;

    // Always move all cards back to storage
    while (body.firstChild) { storage.appendChild(body.firstChild); }

    // Reset state
    body.classList.remove('history-view');
    submissionsState.viewMode = 'month';
    submissionsState.origin = 'month';
    modal.classList.remove('visible');
    document.body.style.overflow = '';
}

var submissionsModalEl = document.getElementById('submissionsModal');
if (submissionsModalEl) {
    submissionsModalEl.addEventListener('click', function(e) {
        if (e.target === this) closeSubmissionsModal();
    });
}

// PDF MODAL FUNCTIONS
function openPdfModal() {
    const modal = document.getElementById('pdfModal');
    const viewer = document.getElementById('pdfViewer');

    // Clear any previous content
    viewer.innerHTML = '';

    // Get PDF URL from data attribute or construct it
    const filename = '{{ lease_data.source_document.filename if lease_data and lease_data.source_document and lease_data.source_document.filename else "" }}';
    if (!filename) {
        viewer.innerHTML = '<p>No PDF available.</p>';
        modal.classList.add('visible');
        document.body.style.overflow = 'hidden';
        return;
    }

    const pdfUrl = '/view_pdf/' + filename;

    // Show modal
    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';

    // Load and render PDF
    pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
        const containerWidth = viewer.clientWidth;

        // Render each page
        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            pdf.getPage(pageNum).then(function(page) {
                // Calculate scale to fit container width
                const viewport = page.getViewport({ scale: 1 });
                const scale = containerWidth / viewport.width;
                const scaledViewport = page.getViewport({ scale: scale });

                // Create canvas for this page
                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-page';
                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;
                viewer.appendChild(canvas);

                // Render page to canvas
                const context = canvas.getContext('2d');
                page.render({
                    canvasContext: context,
                    viewport: scaledViewport
                });
            });
        }
    }).catch(function(error) {
        viewer.innerHTML = '<p>Error loading PDF: ' + error.message + '</p>';
    });
}

function closePdfModal() {
    const modal = document.getElementById('pdfModal');
    const viewer = document.getElementById('pdfViewer');

    // Clear rendered pages
    viewer.innerHTML = '';

    modal.classList.remove('visible');
    document.body.style.overflow = '';
}

// Close PDF modal when clicking outside
document.getElementById('pdfModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closePdfModal();
    }
});

// Close PDF modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const pdfModal = document.getElementById('pdfModal');
        if (pdfModal && pdfModal.classList.contains('visible')) {
            closePdfModal();
        }
    }
});
</script>

<!-- Global loading overlay -->
<div class="global-loading-overlay" id="globalLoadingOverlay">
    <div class="loading-card">
        <div class="global-loading-spinner"></div>
        <div class="global-loading-message" id="globalLoadingMessage"></div>
    </div>
</div>

</body>
</html>
